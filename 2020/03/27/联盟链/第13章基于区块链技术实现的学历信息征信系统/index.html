<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="需求分析">
<meta property="og:type" content="article">
<meta property="og:title" content="第11章基于区块链技术实现学历信息认证">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;03&#x2F;27&#x2F;%E8%81%94%E7%9B%9F%E9%93%BE&#x2F;%E7%AC%AC13%E7%AB%A0%E5%9F%BA%E4%BA%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%AD%A6%E5%8E%86%E4%BF%A1%E6%81%AF%E5%BE%81%E4%BF%A1%E7%B3%BB%E7%BB%9F&#x2F;index.html">
<meta property="og:site_name" content="Hongery">
<meta property="og:description" content="需求分析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;projectArch.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;networkArch.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;dockercompose_up.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;docker_ps.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;dockercompose_down.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;dockercompose_down2.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;saveedu.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;findEduByCertNoAndName.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;findEduInfoByEntityID.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;modifyEdu.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;update_findEduInfoByEntityID.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;update_findEduByCertNoAndName.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;html_login.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;html_index.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;html_help.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;html_addEdu.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;html_queryResultbycert.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;html_query.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;html_query2.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;html_queryResultbyentityid.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;html_modify.png&#x2F;mark">
<meta property="og:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;html_modifyResult.png&#x2F;mark">
<meta property="article:published_time" content="2020-03-27T12:36:33.000Z">
<meta property="article:modified_time" content="2020-03-29T11:01:58.738Z">
<meta property="article:author" content="Hongery">
<meta property="article:tag" content="blockchain">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;image.chaindesk.cn&#x2F;projectArch.png&#x2F;mark">

<link rel="canonical" href="http://yoursite.com/2020/03/27/%E8%81%94%E7%9B%9F%E9%93%BE/%E7%AC%AC13%E7%AB%A0%E5%9F%BA%E4%BA%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%AD%A6%E5%8E%86%E4%BF%A1%E6%81%AF%E5%BE%81%E4%BF%A1%E7%B3%BB%E7%BB%9F/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>第11章基于区块链技术实现学历信息认证 | Hongery</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hongery</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">记录学习中的点点滴滴</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Hongery" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/27/%E8%81%94%E7%9B%9F%E9%93%BE/%E7%AC%AC13%E7%AB%A0%E5%9F%BA%E4%BA%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%AD%A6%E5%8E%86%E4%BF%A1%E6%81%AF%E5%BE%81%E4%BF%A1%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Hongery">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hongery">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          第11章基于区块链技术实现学历信息认证
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-27 20:36:33" itemprop="dateCreated datePublished" datetime="2020-03-27T20:36:33+08:00">2020-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-29 19:01:58" itemprop="dateModified" datetime="2020-03-29T19:01:58+08:00">2020-03-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hyperledger-Fabric/" itemprop="url" rel="index">
                    <span itemprop="name">Hyperledger Fabric</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>55k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>50 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><a id="more"></a>

<h3 id="13-1-1-需求分析"><a href="#13-1-1-需求分析" class="headerlink" title="13.1.1 需求分析"></a>13.1.1 需求分析</h3><p>现在是一个信息化的高科技时代，许许多多的企业必须紧跟时代步伐，不断创新，才能发展壮大；而企业的发展必然离不开人才队伍的建设，也可以说创新是企业发展的动力，而人才却是企业发展的根本，所以现在各企业对于人才队伍建设十分看重，而对于人才的素质及受教育情况的要求更是重中之重。</p>
<p>对学历信息的查询，要么成本较高，要么比较麻烦，甚至还有一些假冒网站让人防不胜防；传统应用是将数据保存在数据库中来实现，但是现在出现的数据库由于故障或者被删、被黑造成的数据丢失的情况更是屡见不鲜，所以传统数据库并不能真正意义上确保数据的完整性及安全性。</p>
<p>基于这些情况，我们设计并开发了一个 <code>基于区块链技术的实现的学历信息征信系统</code>，实现了在线对学历信息的查询功能，由于区块链技术本身的特点，无须考虑数据被破坏的问题，而且杜绝了对于信息造假的情况，保证了学历信息的真实性。由于篇幅原因，我们对学历信息征信系统的应用场景进行修改及简化，实现的业务逻辑包括添加信息、修改信息、查询信息、查询详情信息等操作，实际情况下的的业务逻辑需要根据实际需求场景做出相应的调整。</p>
<p>由于系统需要保证人才受教育情况真实性，所以对于系统的用户而言，不可能由用户自己添加相应的学历信息，而是由具有一定权限的用户来完成添加或修改的功能。但普通用户可以通过系统溯源功能来确定信息的真伪。所以我们将系统用户的使用角色分为两种：</p>
<ol>
<li>普通用户</li>
<li>管理员用户</li>
</ol>
<p>普通用户具有对数据的查询功能 ，但实现查询之前必须经过登录认证：</p>
<ul>
<li>用户登录：系统只针对合法用户进行授权使用，所以用户必须先进行登录才能完成相应的功能。</li>
<li>查询实现：查询分为两种方式实现<ul>
<li>根据证书编号与姓名查询：根据用户输入的证书编号与姓名进行查询。</li>
<li>根据身份证号码查询：根据用户输入指定的身份证号码进行查询，此功能可以实现溯源。</li>
</ul>
</li>
</ul>
<p>管理员用户除具有普通用户的功能之外，额外添加了两个功能：</p>
<ul>
<li>添加信息：可以向系统中添加新的学历信息。</li>
<li>修改信息：针对已存在的学历信息进行修改。</li>
</ul>
<h3 id="13-1-2-架构设计"><a href="#13-1-2-架构设计" class="headerlink" title="13.1.2 架构设计"></a>13.1.2 架构设计</h3><p>我们在本书的第十、十一、十二章中已经完成了一个完整的基于 <code>fabric-sdk-go</code> 的应用示例，所以我们现在使用之前的应用架构，不同的是在此应用中需要编写实现完整的链码并通过业务层调用链码中的各个函数，以实现对数据状态的操作。界面为了方便用户操作使用，仍然使用Web浏览器的方式实现。而且在此应用中我们将 <code>Hyperledger Fabric</code> 默认的状态数据库由 <code>LevelDB</code> 替换为 <code>CouchDB</code> 来实现</p>
<p><img src="http://image.chaindesk.cn/projectArch.png/mark" alt="架构"></p>
<p>对于 <code>Fabric Network</code>结构如下图所示：</p>
<p><img src="http://image.chaindesk.cn/networkArch.png/mark" alt="networkArch"></p>
<h3 id="13-1-3-数据模型设计"><a href="#13-1-3-数据模型设计" class="headerlink" title="13.1.3 数据模型设计"></a>13.1.3 数据模型设计</h3><p>由于需要向分类账本中保存数据，所以必须设计相关的结构体用于声明要保存的数据结构，用于方便的在应用中处理数据。</p>
<p><code>Education</code> 结构体设计如下表所示：</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">数据类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ObjectType</td>
<td align="left">string</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Name</td>
<td align="left">string</td>
<td align="left">姓名</td>
</tr>
<tr>
<td align="left">Gender</td>
<td align="left">string</td>
<td align="left">性别</td>
</tr>
<tr>
<td align="left">Nation</td>
<td align="left">string</td>
<td align="left">民族</td>
</tr>
<tr>
<td align="left">EntityID</td>
<td align="left">string</td>
<td align="left">身份证号（记录的Key）</td>
</tr>
<tr>
<td align="left">Place</td>
<td align="left">string</td>
<td align="left">籍贯</td>
</tr>
<tr>
<td align="left">BirthDay</td>
<td align="left">string</td>
<td align="left">出生日期</td>
</tr>
<tr>
<td align="left">Photo</td>
<td align="left">string</td>
<td align="left">照片</td>
</tr>
<tr>
<td align="left">EnrollDate</td>
<td align="left">string</td>
<td align="left">入学日期</td>
</tr>
<tr>
<td align="left">GraduationDate</td>
<td align="left">string</td>
<td align="left">毕（结）业日期</td>
</tr>
<tr>
<td align="left">SchoolName</td>
<td align="left">string</td>
<td align="left">所读学校名称</td>
</tr>
<tr>
<td align="left">Major</td>
<td align="left">string</td>
<td align="left">所读专业</td>
</tr>
<tr>
<td align="left">QuaType</td>
<td align="left">string</td>
<td align="left">学历类别（普通、成考等）</td>
</tr>
<tr>
<td align="left">Length</td>
<td align="left">string</td>
<td align="left">学制（两年、三年、四年、五年）</td>
</tr>
<tr>
<td align="left">Mode</td>
<td align="left">string</td>
<td align="left">学习形式（普通全日制）</td>
</tr>
<tr>
<td align="left">Level</td>
<td align="left">string</td>
<td align="left">层次（专科、本科、研究生、博士）</td>
</tr>
<tr>
<td align="left">Graduation</td>
<td align="left">string</td>
<td align="left">毕（结）业（毕业、结业）</td>
</tr>
<tr>
<td align="left">CertNo</td>
<td align="left">string</td>
<td align="left">证书编号</td>
</tr>
<tr>
<td align="left">Historys</td>
<td align="left">[]HistoryItem</td>
<td align="left">当前edu的详细历史记录</td>
</tr>
</tbody></table>
<p>为了能够从当前的分类状态中查询出详细的历史操作记录，我们在 <code>Education</code> 中设计了一个类型为<code>HistoryItem</code> 数组的 <code>Historys</code> 成员，表示当前状态的历史记录集。</p>
<p><code>HistoryItem</code> 结构体设计如下表所示：</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">数据类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">TxId</td>
<td align="left">string</td>
<td align="left">交易编号</td>
</tr>
<tr>
<td align="left">Education</td>
<td align="left">Education</td>
<td align="left">本次历史记录的详细信息</td>
</tr>
</tbody></table>
<h3 id="13-1-4-网络环境"><a href="#13-1-4-网络环境" class="headerlink" title="13.1.4 网络环境"></a>13.1.4 网络环境</h3><h4 id="13-1-4-1-设置环境"><a href="#13-1-4-1-设置环境" class="headerlink" title="13.1.4.1 设置环境"></a>13.1.4.1 设置环境</h4><p>我们在第十章中说明了如何构建fabric网络环境，现在我们要重新完成一个新的应用，所以网络环境可以使用之前的内容，但是因为<strong>状态数据库使用 <code>CouchDB</code> 来实现</strong>，所以需要做出部分修改，新增与 <code>CouchDB</code> 相关的内容。为了方便读者起见，我们重新搭建一个应用所需的网络环境。</p>
<p>在<code>GOPATH</code>的<code>src</code>文件夹中新建一个目录如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p <span class="variable">$GOPATH</span>/src/github.com/kongyixueyuan.com/education </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kongyixueyuan.com/education</span></span><br></pre></td></tr></table></figure>

<p>使用 <code>git</code> 命令克隆 hf-fixtures 目录当前路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/kevin-hf/hf-fixtures.git</span></span><br></pre></td></tr></table></figure>

<p>将 hf-fixtures 文件夹重命名为 fixtures</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mv hf-fixtures/fixtures</span></span><br></pre></td></tr></table></figure>

<p>修改<code>fixtures</code> 文件夹的所属关系为当前用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo chown -R kevin:kevin ./fixtures</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>提示： kevin 为安装 Ubuntu 16.04 系统时创建的用户</p>
</blockquote>
<p>进入 <code>fixtures</code> 目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> fixtures</span></span><br></pre></td></tr></table></figure>

<p>为了构建区块链网络，使用 <code>docker</code> 构建处理不同角色的虚拟计算机。 在这里我们将尽可能保持简单。如果确定您的系统中已经存在相关的所需容器，或可以使用其它方式获取，则无需执行如下命令。否则请将 <code>fixtures</code> 目录下的 <code>pull_images.sh</code> 文件添加可执行权限后直接执行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> chmod 777 ./pull_images.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./pull_images.sh</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>提示：<code>pull_images.sh</code> 文件是下载 Fabric 环境所需容器的一个可执行脚本，下载过程需要一段时间（视网速情况而定），请耐心等待。另：请确定您的系统支持虚拟技术。</p>
</blockquote>
<h4 id="13-1-4-2-配置docker-compose-yml文件"><a href="#13-1-4-2-配置docker-compose-yml文件" class="headerlink" title="13.1.4.2 配置docker-compose.yml文件"></a>13.1.4.2 配置docker-compose.yml文件</h4><p>在 <code>fixtures</code> 目录下创建一个 <code>docker-compose.yml</code> 文件并编辑</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim docker-compose.yml</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>将 <code>network下的basic</code> 修改为 <code>default</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑 orderer 部分</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">orderer.kevin.kongyixueyuan.com:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">hyperledger/fabric-orderer</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">orderer.kevin.kongyixueyuan.com</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_LOGLEVEL=debug</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_LISTENADDRESS=0.0.0.0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_LISTENPORT=7050</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_GENESISPROFILE=kongyixueyuan</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_GENESISMETHOD=file</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/genesis.block</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_LOCALMSPID=kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_ENABLED=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]</span></span><br><span class="line">  <span class="attr">working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">orderer</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./artifacts/genesis.block:/var/hyperledger/orderer/genesis.block</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./crypto-config/ordererOrganizations/kevin.kongyixueyuan.com/orderers/orderer.kevin.kongyixueyuan.com/msp:/var/hyperledger/orderer/msp</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./crypto-config/ordererOrganizations/kevin.kongyixueyuan.com/orderers/orderer.kevin.kongyixueyuan.com/tls:/var/hyperledger/orderer/tls</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">7050</span><span class="string">:7050</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">aliases:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">orderer.kevin.kongyixueyuan.com</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑 ca 部分</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ca.org1.kevin.kongyixueyuan.com:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">hyperledger/fabric-ca</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">ca.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">FABRIC_CA_SERVER_CA_NAME=ca.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">FABRIC_CA_SERVER_CA_CERTFILE=/etc/hyperledger/fabric-ca-server-config/ca.org1.kevin.kongyixueyuan.com-cert.pem</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">FABRIC_CA_SERVER_CA_KEYFILE=/etc/hyperledger/fabric-ca-server-config/727e69ed4a01a204cd53bf4a97c2c1cb947419504f82851f6ae563c3c96dea3a_sk</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">FABRIC_CA_SERVER_TLS_ENABLED=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">FABRIC_CA_SERVER_TLS_CERTFILE=/etc/hyperledger/fabric-ca-server-config/ca.org1.kevin.kongyixueyuan.com-cert.pem</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">FABRIC_CA_SERVER_TLS_KEYFILE=/etc/hyperledger/fabric-ca-server-config/727e69ed4a01a204cd53bf4a97c2c1cb947419504f82851f6ae563c3c96dea3a_sk</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">7054</span><span class="string">:7054</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">sh</span> <span class="string">-c</span> <span class="string">'fabric-ca-server start -b admin:adminpw -d'</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./crypto-config/peerOrganizations/org1.kevin.kongyixueyuan.com/ca/:/etc/hyperledger/fabric-ca-server-config</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">aliases:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ca.org1.kevin.kongyixueyuan.com</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>声明 CouchDB 部分：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">couchdb:</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">couchdb</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">hyperledger/fabric-couchdb</span></span><br><span class="line">  <span class="comment"># Populate the COUCHDB_USER and COUCHDB_PASSWORD to set an admin user and password</span></span><br><span class="line">  <span class="comment"># for CouchDB.  This will prevent CouchDB from operating in an "Admin Party" mode.</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">COUCHDB_USER=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">COUCHDB_PASSWORD=</span></span><br><span class="line">  <span class="comment"># Comment/Uncomment the port mapping if you want to hide/expose the CouchDB service,</span></span><br><span class="line">  <span class="comment"># for example map it to utilize Fauxton User Interface in dev environments.</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"5984:5984"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑Peer部分</p>
<ol>
<li><p><code>peer0.org1.example.com</code> 内容如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">peer0.org1.kevin.kongyixueyuan.com:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">hyperledger/fabric-peer</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">peer0.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_VM_DOCKER_ATTACHSTDOUT=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_LOGGING_LEVEL=DEBUG</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_NETWORKID=kongyixueyuan</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_PROFILE_ENABLED=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/var/hyperledger/tls/server.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/var/hyperledger/tls/server.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/var/hyperledger/tls/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_ID=peer0.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_ADDRESSAUTODETECT=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.kevin.kongyixueyuan.com:7051</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.kevin.kongyixueyuan.com:7051</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_GOSSIP_USELEADERELECTION=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_GOSSIP_ORGLEADER=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_GOSSIP_SKIPHANDSHAKE=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_LOCALMSPID=org1.kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/var/hyperledger/msp</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_SERVERHOSTOVERRIDE=peer0.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_LEDGER_STATE_STATEDATABASE=CouchDB</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb:5984</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=</span></span><br><span class="line">  <span class="attr">working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">peer</span> <span class="string">node</span> <span class="string">start</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/run/:/host/var/run/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./crypto-config/peerOrganizations/org1.kevin.kongyixueyuan.com/peers/peer0.org1.kevin.kongyixueyuan.com/msp:/var/hyperledger/msp</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./crypto-config/peerOrganizations/org1.kevin.kongyixueyuan.com/peers/peer0.org1.kevin.kongyixueyuan.com/tls:/var/hyperledger/tls</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">7051</span><span class="string">:7051</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">7053</span><span class="string">:7053</span></span><br><span class="line">  <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">orderer.kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">couchdb</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">aliases:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">peer0.org1.kevin.kongyixueyuan.com</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>peer1.org1.example.com 内容如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">peer1.org1.kevin.kongyixueyuan.com:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">hyperledger/fabric-peer</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">peer1.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_VM_DOCKER_ATTACHSTDOUT=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_LOGGING_LEVEL=DEBUG</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_NETWORKID=kongyixueyuan</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_PROFILE_ENABLED=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/var/hyperledger/tls/server.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/var/hyperledger/tls/server.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/var/hyperledger/tls/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_ID=peer1.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_ADDRESSAUTODETECT=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_ADDRESS=peer1.org1.kevin.kongyixueyuan.com:7051</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.kevin.kongyixueyuan.com:7051</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_GOSSIP_USELEADERELECTION=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_GOSSIP_ORGLEADER=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_GOSSIP_SKIPHANDSHAKE=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_LOCALMSPID=org1.kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/var/hyperledger/msp</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_SERVERHOSTOVERRIDE=peer1.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_LEDGER_STATE_STATEDATABASE=CouchDB</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb:5984</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=</span></span><br><span class="line">  <span class="attr">working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">peer</span> <span class="string">node</span> <span class="string">start</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/run/:/host/var/run/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./crypto-config/peerOrganizations/org1.kevin.kongyixueyuan.com/peers/peer1.org1.kevin.kongyixueyuan.com/msp:/var/hyperledger/msp</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./crypto-config/peerOrganizations/org1.kevin.kongyixueyuan.com/peers/peer1.org1.kevin.kongyixueyuan.com/tls:/var/hyperledger/tls</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">7151</span><span class="string">:7051</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">7153</span><span class="string">:7053</span></span><br><span class="line">  <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">orderer.kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">couchdb</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">aliases:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">peer1.org1.kevin.kongyixueyuan.com</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
</li>
</ol>
<h3 id="13-1-5-测试网络环境"><a href="#13-1-5-测试网络环境" class="headerlink" title="13.1.5 测试网络环境"></a>13.1.5 测试网络环境</h3><p>为了检查网络是否正常工作，使用<code>docker-compose</code>同时启动或停止所有容器。 进入<code>fixtures</code>文件夹，运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kongyixueyuan.com/education/fixtures</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker-compose up</span></span><br></pre></td></tr></table></figure>

<p>如果在您的系统中没有相关的容器，那么会自动下载docker镜像。下载完毕后自动启动，控制台会输出很多不同颜色的日志（红色不等于错误）</p>
<p><img src="http://image.chaindesk.cn/dockercompose_up.png/mark" alt="启动网络"></p>
<p>打开一个新终端并运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker ps</span></span><br></pre></td></tr></table></figure>

<p><img src="http://image.chaindesk.cn/docker_ps.png/mark" alt="查看容器"></p>
<p>将看到：两个peer，一个orderer和一个CA容器，还有一个 CouchDB 容器。 代表已成功创建了一个新的网络，可以随SDK一起使用。 要停止网络，请返回到上一个终端，按<code>Ctrl+C</code>并等待所有容器都停止。</p>
<blockquote>
<p><strong>提示</strong> ：当网络成功启动后，所有处于活动中的容器都可以访问。 也可以查看指定容器的详细日志内容。 如果想删除这些容器，需要使用<code>docker rm $(docker ps -aq)</code>将其删除 ，但在删除容器之前需要确定其在网络环境中已不再使用。</p>
<p>如果在网络环境启动过程中不想看到大量的日志信息，请在该启动命令中添加参数 <code>-d</code> ，如下所示： <code>docker-compose up -d</code> 。 如果要停止网络，请务必在 <code>docker-compose.yaml</code> 所在的文件夹中运行命令： <code>docker-compose stop</code> （或 使用<code>docker-compose down</code> 进行清理停止所有容器）。</p>
</blockquote>
<p>最后在终端2中执行如下命令关闭网络：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kongyixueyuan.com/education/fixtures</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker-compose down</span></span><br></pre></td></tr></table></figure>

<p><img src="http://image.chaindesk.cn/dockercompose_down.png/mark" alt="关闭网络"></p>
<p>终端1窗口中输出如下：</p>
<p><img src="http://image.chaindesk.cn/dockercompose_down2.png/mark" alt="关闭网络过程"></p>
<h3 id="SDK与链码的实现"><a href="#SDK与链码的实现" class="headerlink" title="SDK与链码的实现"></a>SDK与链码的实现</h3><h3 id="13-2-1-创建-config-yaml-文件"><a href="#13-2-1-创建-config-yaml-文件" class="headerlink" title="13.2.1 创建 config.yaml 文件"></a>13.2.1 创建 <code>config.yaml</code> 文件</h3><p>确认 Hyperledger Fabric 基础网络环境运行没有问题后，现在我们通过创建一个新的 config.yaml 配置文件给应用程序所使用的 Fabric-SDK-Go 配置相关参数及 Fabric 组件的通信地址</p>
<p>进入项目的根目录中创建一个 <code>config.yaml</code> 文件并编辑</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kongyixueyuan.com/education</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim config.yaml</span></span><br></pre></td></tr></table></figure>

<p>config.yaml 配置文件完整内容如下:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">"kongyixueyuan-network"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Schema version of the content. Used by the SDK to apply the corresponding parsing rules.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The client section used by GO SDK.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">client:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Which organization does this application instance belong to? The value must be the name of an org</span></span><br><span class="line">  <span class="comment"># defined under "organizations"</span></span><br><span class="line">  <span class="attr">organization:</span> <span class="string">Org1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">logging:</span></span><br><span class="line">    <span class="attr">level:</span> <span class="string">info</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Global configuration for peer, event service and orderer timeouts</span></span><br><span class="line">  <span class="comment"># if this this section is omitted, then default values will be used (same values as below)</span></span><br><span class="line"><span class="comment">#  peer:</span></span><br><span class="line"><span class="comment">#    timeout:</span></span><br><span class="line"><span class="comment">#      connection: 10s</span></span><br><span class="line"><span class="comment">#      response: 180s</span></span><br><span class="line"><span class="comment">#      discovery:</span></span><br><span class="line"><span class="comment">#        # Expiry period for discovery service greylist filter</span></span><br><span class="line"><span class="comment">#        # The channel client will greylist peers that are found to be offline</span></span><br><span class="line"><span class="comment">#        # to prevent re-selecting them in subsequent retries.</span></span><br><span class="line"><span class="comment">#        # This interval will define how long a peer is greylisted</span></span><br><span class="line"><span class="comment">#        greylistExpiry: 10s</span></span><br><span class="line"><span class="comment">#  eventService:</span></span><br><span class="line"><span class="comment">#    # Event service type (optional). If not specified then the type is automatically</span></span><br><span class="line"><span class="comment">#    # determined from channel capabilities.</span></span><br><span class="line"><span class="comment">#    type: (deliver|eventhub)</span></span><br><span class="line">    <span class="comment"># the below timeouts are commented out to use the default values that are found in</span></span><br><span class="line">    <span class="comment"># "pkg/fab/endpointconfig.go"</span></span><br><span class="line">    <span class="comment"># the client is free to override the default values by uncommenting and resetting</span></span><br><span class="line">    <span class="comment"># the values as they see fit in their config file</span></span><br><span class="line"><span class="comment">#    timeout:</span></span><br><span class="line"><span class="comment">#      connection: 15s</span></span><br><span class="line"><span class="comment">#      registrationResponse: 15s</span></span><br><span class="line"><span class="comment">#  orderer:</span></span><br><span class="line"><span class="comment">#    timeout:</span></span><br><span class="line"><span class="comment">#      connection: 15s</span></span><br><span class="line"><span class="comment">#      response: 15s</span></span><br><span class="line"><span class="comment">#  global:</span></span><br><span class="line"><span class="comment">#    timeout:</span></span><br><span class="line"><span class="comment">#      query: 180s</span></span><br><span class="line"><span class="comment">#      execute: 180s</span></span><br><span class="line"><span class="comment">#      resmgmt: 180s</span></span><br><span class="line"><span class="comment">#    cache:</span></span><br><span class="line"><span class="comment">#      connectionIdle: 30s</span></span><br><span class="line"><span class="comment">#      eventServiceIdle: 2m</span></span><br><span class="line"><span class="comment">#      channelConfig: 30m</span></span><br><span class="line"><span class="comment">#      channelMembership: 30s</span></span><br><span class="line"><span class="comment">#      discovery: 10s</span></span><br><span class="line"><span class="comment">#      selection: 10m</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Root of the MSP directories with keys and certs.</span></span><br><span class="line">  <span class="attr">cryptoconfig:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">$&#123;GOPATH&#125;/src/github.com/kongyixueyuan.com/education/fixtures/crypto-config</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Some SDKs support pluggable KV stores, the properties under "credentialStore"</span></span><br><span class="line">  <span class="comment"># are implementation specific</span></span><br><span class="line">  <span class="attr">credentialStore:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/kongyixueyuan-store</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># [Optional]. Specific to the CryptoSuite implementation used by GO SDK. Software-based implementations</span></span><br><span class="line">    <span class="comment"># requiring a key store. PKCS#11 based implementations does not.</span></span><br><span class="line">    <span class="attr">cryptoStore:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/tmp/kongyixueyuan-msp</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># BCCSP config for the client. Used by GO SDK.</span></span><br><span class="line">  <span class="attr">BCCSP:</span></span><br><span class="line">    <span class="attr">security:</span></span><br><span class="line">     <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">     <span class="attr">default:</span></span><br><span class="line">      <span class="attr">provider:</span> <span class="string">"SW"</span></span><br><span class="line">     <span class="attr">hashAlgorithm:</span> <span class="string">"SHA2"</span></span><br><span class="line">     <span class="attr">softVerify:</span> <span class="literal">true</span></span><br><span class="line">     <span class="attr">level:</span> <span class="number">256</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tlsCerts:</span></span><br><span class="line">    <span class="comment"># [Optional]. Use system certificate pool when connecting to peers, orderers (for negotiating TLS) Default: false</span></span><br><span class="line">    <span class="attr">systemCertPool:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># [Optional]. Client key and cert for TLS handshake with peers and orderers</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">      <span class="attr">key:</span></span><br><span class="line">        <span class="attr">path:</span></span><br><span class="line">      <span class="attr">cert:</span></span><br><span class="line">        <span class="attr">path:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># [Optional]. But most apps would have this section so that channel objects can be constructed</span></span><br><span class="line"><span class="comment"># based on the content below. If an app is creating channels, then it likely will not need this</span></span><br><span class="line"><span class="comment"># section.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">channels:</span></span><br><span class="line">  <span class="comment"># name of the channel</span></span><br><span class="line">  <span class="attr">kevinkongyixueyuan:</span></span><br><span class="line">    <span class="comment"># Required. list of orderers designated by the application to use for transactions on this</span></span><br><span class="line">    <span class="comment"># channel. This list can be a result of access control ("org1" can only access "ordererA"), or</span></span><br><span class="line">    <span class="comment"># operational decisions to share loads from applications among the orderers.  The values must</span></span><br><span class="line">    <span class="comment"># be "names" of orgs defined under "organizations/peers"</span></span><br><span class="line">    <span class="comment"># deprecated: not recommended, to override any orderer configuration items, entity matchers should be used.</span></span><br><span class="line">    <span class="comment"># orderers:</span></span><br><span class="line">    <span class="comment">#  - orderer.kevin.kongyixueyuan.com</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Required. list of peers from participating orgs</span></span><br><span class="line">    <span class="attr">peers:</span></span><br><span class="line">      <span class="attr">peer0.org1.kevin.kongyixueyuan.com:</span></span><br><span class="line">        <span class="comment"># [Optional]. will this peer be sent transaction proposals for endorsement? The peer must</span></span><br><span class="line">        <span class="comment"># have the chaincode installed. The app can also use this property to decide which peers</span></span><br><span class="line">        <span class="comment"># to send the chaincode install request. Default: true</span></span><br><span class="line">        <span class="attr">endorsingPeer:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># [Optional]. will this peer be sent query proposals? The peer must have the chaincode</span></span><br><span class="line">        <span class="comment"># installed. The app can also use this property to decide which peers to send the</span></span><br><span class="line">        <span class="comment"># chaincode install request. Default: true</span></span><br><span class="line">        <span class="attr">chaincodeQuery:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># [Optional]. will this peer be sent query proposals that do not require chaincodes, like</span></span><br><span class="line">        <span class="comment"># queryBlock(), queryTransaction(), etc. Default: true</span></span><br><span class="line">        <span class="attr">ledgerQuery:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># [Optional]. will this peer be the target of the SDK's listener registration? All peers can</span></span><br><span class="line">        <span class="comment"># produce events but the app typically only needs to connect to one to listen to events.</span></span><br><span class="line">        <span class="comment"># Default: true</span></span><br><span class="line">        <span class="attr">eventSource:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">peer1.org1.kevin.kongyixueyuan.com:</span></span><br><span class="line">        <span class="attr">endorsingPeer:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">chaincodeQuery:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">ledgerQuery:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">eventSource:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">policies:</span></span><br><span class="line">      <span class="comment">#[Optional] options for retrieving channel configuration blocks</span></span><br><span class="line">      <span class="attr">queryChannelConfig:</span></span><br><span class="line">        <span class="comment">#[Optional] min number of success responses (from targets/peers)</span></span><br><span class="line">        <span class="attr">minResponses:</span> <span class="number">1</span></span><br><span class="line">        <span class="comment">#[Optional] channel config will be retrieved for these number of random targets</span></span><br><span class="line">        <span class="attr">maxTargets:</span> <span class="number">1</span></span><br><span class="line">        <span class="comment">#[Optional] retry options for query config block</span></span><br><span class="line">        <span class="attr">retryOpts:</span></span><br><span class="line">          <span class="comment">#[Optional] number of retry attempts</span></span><br><span class="line">          <span class="attr">attempts:</span> <span class="number">5</span></span><br><span class="line">          <span class="comment">#[Optional] the back off interval for the first retry attempt</span></span><br><span class="line">          <span class="attr">initialBackoff:</span> <span class="string">500ms</span></span><br><span class="line">          <span class="comment">#[Optional] the maximum back off interval for any retry attempt</span></span><br><span class="line">          <span class="attr">maxBackoff:</span> <span class="string">5s</span></span><br><span class="line">          <span class="comment">#[Optional] he factor by which the initial back off period is exponentially incremented</span></span><br><span class="line">          <span class="attr">backoffFactor:</span> <span class="number">2.0</span></span><br><span class="line">      <span class="comment">#[Optional] options for retrieving discovery info</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#[Optional] discovery info will be retrieved for these number of random targets</span></span><br><span class="line">        <span class="attr">maxTargets:</span> <span class="number">2</span></span><br><span class="line">        <span class="comment">#[Optional] retry options for retrieving discovery info</span></span><br><span class="line">        <span class="attr">retryOpts:</span></span><br><span class="line">          <span class="comment">#[Optional] number of retry attempts</span></span><br><span class="line">          <span class="attr">attempts:</span> <span class="number">4</span></span><br><span class="line">          <span class="comment">#[Optional] the back off interval for the first retry attempt</span></span><br><span class="line">          <span class="attr">initialBackoff:</span> <span class="string">500ms</span></span><br><span class="line">          <span class="comment">#[Optional] the maximum back off interval for any retry attempt</span></span><br><span class="line">          <span class="attr">maxBackoff:</span> <span class="string">5s</span></span><br><span class="line">          <span class="comment">#[Optional] he factor by which the initial back off period is exponentially incremented</span></span><br><span class="line">          <span class="attr">backoffFactor:</span> <span class="number">2.0</span></span><br><span class="line">      <span class="comment">#[Optional] options for the event service</span></span><br><span class="line">      <span class="attr">eventService:</span></span><br><span class="line">        <span class="comment"># [Optional] resolverStrategy specifies the peer resolver strategy to use when connecting to a peer</span></span><br><span class="line">        <span class="comment"># Possible values: [PreferOrg (default), MinBlockHeight, Balanced]</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># PreferOrg:</span></span><br><span class="line">        <span class="comment">#   Determines which peers are suitable based on block height lag threshold, although will prefer the peers in the</span></span><br><span class="line">        <span class="comment">#   current org (as long as their block height is above a configured threshold). If none of the peers from the current org</span></span><br><span class="line">        <span class="comment">#   are suitable then a peer from another org is chosen.</span></span><br><span class="line">        <span class="comment"># MinBlockHeight:</span></span><br><span class="line">        <span class="comment">#   Chooses the best peer according to a block height lag threshold. The maximum block height of all peers is</span></span><br><span class="line">        <span class="comment">#   determined and the peers whose block heights are under the maximum height but above a provided "lag" threshold are load</span></span><br><span class="line">        <span class="comment">#   balanced. The other peers are not considered.</span></span><br><span class="line">        <span class="comment"># Balanced:</span></span><br><span class="line">        <span class="comment">#   Chooses peers using the configured balancer.</span></span><br><span class="line">        <span class="attr">resolverStrategy:</span> <span class="string">PreferOrg</span></span><br><span class="line">        <span class="comment"># [Optional] balancer is the balancer to use when choosing a peer to connect to</span></span><br><span class="line">        <span class="comment"># Possible values: [Random (default), RoundRobin]</span></span><br><span class="line">        <span class="attr">balancer:</span> <span class="string">Random</span></span><br><span class="line">        <span class="comment"># [Optional] blockHeightLagThreshold sets the block height lag threshold. This value is used for choosing a peer</span></span><br><span class="line">        <span class="comment"># to connect to. If a peer is lagging behind the most up-to-date peer by more than the given number of</span></span><br><span class="line">        <span class="comment"># blocks then it will be excluded from selection.</span></span><br><span class="line">        <span class="comment"># If set to 0 then only the most up-to-date peers are considered.</span></span><br><span class="line">        <span class="comment"># If set to -1 then all peers (regardless of block height) are considered for selection.</span></span><br><span class="line">        <span class="comment"># Default: 5</span></span><br><span class="line">        <span class="attr">blockHeightLagThreshold:</span> <span class="number">5</span></span><br><span class="line">        <span class="comment"># [Optional] reconnectBlockHeightLagThreshold - if &gt;0 then the event client will disconnect from the peer if the peer's</span></span><br><span class="line">        <span class="comment"># block height falls behind the specified number of blocks and will reconnect to a better performing peer.</span></span><br><span class="line">        <span class="comment"># If set to 0 then this feature is disabled.</span></span><br><span class="line">        <span class="comment"># Default: 10</span></span><br><span class="line">        <span class="comment"># NOTES:</span></span><br><span class="line">        <span class="comment">#   - peerMonitorPeriod must be &gt;0 to enable this feature</span></span><br><span class="line">        <span class="comment">#   - Setting this value too low may cause the event client to disconnect/reconnect too frequently, thereby</span></span><br><span class="line">        <span class="comment">#     affecting performance.</span></span><br><span class="line">        <span class="attr">reconnectBlockHeightLagThreshold:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment"># [Optional] peerMonitorPeriod is the period in which the connected peer is monitored to see if</span></span><br><span class="line">        <span class="comment"># the event client should disconnect from it and reconnect to another peer.</span></span><br><span class="line">        <span class="comment"># Default: 0 (disabled)</span></span><br><span class="line">        <span class="attr">peerMonitorPeriod:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># list of participating organizations in this network</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">organizations:</span></span><br><span class="line">  <span class="attr">Org1:</span></span><br><span class="line">    <span class="attr">mspid:</span> <span class="string">org1.kevin.kongyixueyuan.com</span></span><br><span class="line">    <span class="attr">cryptoPath:</span> <span class="string">peerOrganizations/org1.kevin.kongyixueyuan.com/users/&#123;userName&#125;@org1.kevin.kongyixueyuan.com/msp</span></span><br><span class="line">    <span class="attr">peers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">peer0.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">peer1.org1.kevin.kongyixueyuan.com</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># [Optional]. Certificate Authorities issue certificates for identification purposes in a Fabric based</span></span><br><span class="line">    <span class="comment"># network. Typically certificates provisioning is done in a separate process outside of the</span></span><br><span class="line">    <span class="comment"># runtime network. Fabric-CA is a special certificate authority that provides a REST APIs for</span></span><br><span class="line">    <span class="comment"># dynamic certificate management (enroll, revoke, re-enroll). The following section is only for</span></span><br><span class="line">    <span class="comment"># Fabric-CA servers.</span></span><br><span class="line">    <span class="attr">certificateAuthorities:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ca.org1.kevin.kongyixueyuan.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># List of orderers to send transaction and channel create/update requests to. For the time</span></span><br><span class="line"><span class="comment"># being only one orderer is needed. If more than one is defined, which one get used by the</span></span><br><span class="line"><span class="comment"># SDK is implementation specific. Consult each SDK's documentation for its handling of orderers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">orderers:</span></span><br><span class="line">  <span class="attr">orderer.kevin.kongyixueyuan.com:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">localhost:7050</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># these are standard properties defined by the gRPC library</span></span><br><span class="line">    <span class="comment"># they will be passed in as-is to gRPC client constructor</span></span><br><span class="line">    <span class="attr">grpcOptions:</span></span><br><span class="line">      <span class="attr">ssl-target-name-override:</span> <span class="string">orderer.kevin.kongyixueyuan.com</span></span><br><span class="line">      <span class="comment"># These parameters should be set in coordination with the keepalive policy on the server,</span></span><br><span class="line">      <span class="comment"># as incompatible settings can result in closing of connection.</span></span><br><span class="line">      <span class="comment"># When duration of the 'keep-alive-time' is set to 0 or less the keep alive client parameters are disabled</span></span><br><span class="line">      <span class="attr">keep-alive-time:</span> <span class="string">0s</span></span><br><span class="line">      <span class="attr">keep-alive-timeout:</span> <span class="string">20s</span></span><br><span class="line">      <span class="attr">keep-alive-permit:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">fail-fast:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment"># allow-insecure will be taken into consideration if address has no protocol defined, if true then grpc or else grpcs</span></span><br><span class="line">      <span class="attr">allow-insecure:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">tlsCACerts:</span></span><br><span class="line">      <span class="comment"># Certificate location absolute path</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">$&#123;GOPATH&#125;/src/github.com/kongyixueyuan.com/education/fixtures/crypto-config/ordererOrganizations/kevin.kongyixueyuan.com/tlsca/tlsca.kevin.kongyixueyuan.com-cert.pem</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># List of peers to send various requests to, including endorsement, query</span></span><br><span class="line"><span class="comment"># and event listener registration.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">peers:</span></span><br><span class="line">  <span class="attr">peer0.org1.kevin.kongyixueyuan.com:</span></span><br><span class="line">    <span class="comment"># this URL is used to send endorsement and query requests</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">localhost:7051</span></span><br><span class="line">    <span class="comment"># eventUrl is only needed when using eventhub (default is delivery service)</span></span><br><span class="line">    <span class="attr">eventUrl:</span> <span class="string">localhost:7053</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">grpcOptions:</span></span><br><span class="line">      <span class="attr">ssl-target-name-override:</span> <span class="string">peer0.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">      <span class="comment"># These parameters should be set in coordination with the keepalive policy on the server,</span></span><br><span class="line">      <span class="comment"># as incompatible settings can result in closing of connection.</span></span><br><span class="line">      <span class="comment"># When duration of the 'keep-alive-time' is set to 0 or less the keep alive client parameters are disabled</span></span><br><span class="line">      <span class="attr">keep-alive-time:</span> <span class="string">0s</span></span><br><span class="line">      <span class="attr">keep-alive-timeout:</span> <span class="string">20s</span></span><br><span class="line">      <span class="attr">keep-alive-permit:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">fail-fast:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment"># allow-insecure will be taken into consideration if address has no protocol defined, if true then grpc or else grpcs</span></span><br><span class="line">      <span class="attr">allow-insecure:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">tlsCACerts:</span></span><br><span class="line">      <span class="comment"># Certificate location absolute path</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">$&#123;GOPATH&#125;/src/github.com/kongyixueyuan.com/education/fixtures/crypto-config/peerOrganizations/org1.kevin.kongyixueyuan.com/tlsca/tlsca.org1.kevin.kongyixueyuan.com-cert.pem</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">peer1.org1.kevin.kongyixueyuan.com:</span></span><br><span class="line">    <span class="comment"># this URL is used to send endorsement and query requests</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">localhost:7151</span></span><br><span class="line">    <span class="comment"># eventUrl is only needed when using eventhub (default is delivery service)</span></span><br><span class="line">    <span class="attr">eventUrl:</span> <span class="string">localhost:7153</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">grpcOptions:</span></span><br><span class="line">      <span class="attr">ssl-target-name-override:</span> <span class="string">peer1.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">      <span class="comment"># These parameters should be set in coordination with the keepalive policy on the server,</span></span><br><span class="line">      <span class="comment"># as incompatible settings can result in closing of connection.</span></span><br><span class="line">      <span class="comment"># When duration of the 'keep-alive-time' is set to 0 or less the keep alive client parameters are disabled</span></span><br><span class="line">      <span class="attr">keep-alive-time:</span> <span class="string">0s</span></span><br><span class="line">      <span class="attr">keep-alive-timeout:</span> <span class="string">20s</span></span><br><span class="line">      <span class="attr">keep-alive-permit:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">fail-fast:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment"># allow-insecure will be taken into consideration if address has no protocol defined, if true then grpc or else grpcs</span></span><br><span class="line">      <span class="attr">allow-insecure:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">tlsCACerts:</span></span><br><span class="line">      <span class="comment"># Certificate location absolute path</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">$&#123;GOPATH&#125;/src/github.com/kongyixueyuan.com/education/fixtures/crypto-config/peerOrganizations/org1.kevin.kongyixueyuan.com/tlsca/tlsca.org1.kevin.kongyixueyuan.com-cert.pem</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Fabric-CA is a special kind of Certificate Authority provided by Hyperledger Fabric which allows</span></span><br><span class="line"><span class="comment"># certificate management to be done via REST APIs. Application may choose to use a standard</span></span><br><span class="line"><span class="comment"># Certificate Authority instead of Fabric-CA, in which case this section would not be specified.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">certificateAuthorities:</span></span><br><span class="line">  <span class="attr">ca.org1.kevin.kongyixueyuan.com:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://localhost:7054</span></span><br><span class="line">    <span class="attr">tlsCACerts:</span></span><br><span class="line">      <span class="comment"># Certificate location absolute path</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">$&#123;GOPATH&#125;/src/github.com/kongyixueyuan.com/education/fixtures/crypto-config/peerOrganizations/org1.kevin.kongyixueyuan.com/ca/ca.org1.kevin.kongyixueyuan.com-cert.pem</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Fabric-CA supports dynamic user enrollment via REST APIs. A "root" user, a.k.a registrar, is</span></span><br><span class="line">    <span class="comment"># needed to enroll and invoke new users.</span></span><br><span class="line">    <span class="attr">registrar:</span></span><br><span class="line">      <span class="attr">enrollId:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">enrollSecret:</span> <span class="string">adminpw</span></span><br><span class="line">    <span class="comment"># [Optional] The optional name of the CA.</span></span><br><span class="line">    <span class="attr">caName:</span> <span class="string">ca.org1.kevin.kongyixueyuan.com</span></span><br><span class="line"></span><br><span class="line"><span class="attr">entityMatchers:</span></span><br><span class="line">  <span class="attr">peer:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">(\w*)peer0.org1.kevin.kongyixueyuan.com(\w*)</span></span><br><span class="line">      <span class="attr">urlSubstitutionExp:</span> <span class="string">localhost:7051</span></span><br><span class="line">      <span class="attr">eventUrlSubstitutionExp:</span> <span class="string">localhost:7053</span></span><br><span class="line">      <span class="attr">sslTargetOverrideUrlSubstitutionExp:</span> <span class="string">peer0.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">      <span class="attr">mappedHost:</span> <span class="string">peer0.org1.kevin.kongyixueyuan.com</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">(\w*)peer1.org1.kevin.kongyixueyuan.com(\w*)</span></span><br><span class="line">      <span class="attr">urlSubstitutionExp:</span> <span class="string">localhost:7151</span></span><br><span class="line">      <span class="attr">eventUrlSubstitutionExp:</span> <span class="string">localhost:7153</span></span><br><span class="line">      <span class="attr">sslTargetOverrideUrlSubstitutionExp:</span> <span class="string">peer1.org1.kevin.kongyixueyuan.com</span></span><br><span class="line">      <span class="attr">mappedHost:</span> <span class="string">peer1.org1.kevin.kongyixueyuan.com</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">orderer:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">(\w*)orderer.kevin.kongyixueyuan.com(\w*)</span></span><br><span class="line">      <span class="attr">urlSubstitutionExp:</span> <span class="string">localhost:7050</span></span><br><span class="line">      <span class="attr">sslTargetOverrideUrlSubstitutionExp:</span> <span class="string">orderer.kevin.kongyixueyuan.com</span></span><br><span class="line">      <span class="attr">mappedHost:</span> <span class="string">orderer.kevin.kongyixueyuan.com</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">certificateAuthorities:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">(\w*)ca.org1.kevin.kongyixueyuan.com(\w*)</span></span><br><span class="line">      <span class="attr">urlSubstitutionExp:</span> <span class="string">http://localhost:7054</span></span><br><span class="line">      <span class="attr">mappedHost:</span> <span class="string">ca.org1.kevin.kongyixueyuan.com</span></span><br></pre></td></tr></table></figure>

<h3 id="13-2-2-声明结构体"><a href="#13-2-2-声明结构体" class="headerlink" title="13.2.2 声明结构体"></a>13.2.2 声明结构体</h3><p>在当前项目根目录中创建一个存放链码文件的 <code>chaincode</code> 目录，然后在该目录下创建一个 <code>eduStruct.go</code> 的文件并对其进行编辑</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir chaincode</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim chaincode/eduStruct.go</span></span><br></pre></td></tr></table></figure>

<p><code>eduStruct.go</code> 文件主要声明一个结构体，用于将多个数据包装成为一个对象，然后进行进一步的处理。该文件完整代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  @Author : hanxiaodong</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Education <span class="keyword">struct</span> &#123;</span><br><span class="line">    ObjectType    <span class="keyword">string</span>    <span class="string">`json:"docType"`</span></span><br><span class="line">    Name    <span class="keyword">string</span>    <span class="string">`json:"Name"`</span>        <span class="comment">// 姓名</span></span><br><span class="line">    Gender    <span class="keyword">string</span>    <span class="string">`json:"Gender"`</span>        <span class="comment">// 性别</span></span><br><span class="line">    Nation    <span class="keyword">string</span>    <span class="string">`json:"Nation"`</span>        <span class="comment">// 民族</span></span><br><span class="line">    EntityID    <span class="keyword">string</span>    <span class="string">`json:"EntityID"`</span>        <span class="comment">// 身份证号</span></span><br><span class="line">    Place    <span class="keyword">string</span>    <span class="string">`json:"Place"`</span>        <span class="comment">// 籍贯</span></span><br><span class="line">    BirthDay    <span class="keyword">string</span>    <span class="string">`json:"BirthDay"`</span>        <span class="comment">// 出生日期</span></span><br><span class="line"></span><br><span class="line">    EnrollDate    <span class="keyword">string</span>    <span class="string">`json:"EnrollDate"`</span>        <span class="comment">// 入学日期</span></span><br><span class="line">    GraduationDate    <span class="keyword">string</span>    <span class="string">`json:"GraduationDate"`</span>    <span class="comment">// 毕（结）业日期</span></span><br><span class="line">    SchoolName    <span class="keyword">string</span>    <span class="string">`json:"SchoolName"`</span>    <span class="comment">// 学校名称</span></span><br><span class="line">    Major    <span class="keyword">string</span>    <span class="string">`json:"Major"`</span>    <span class="comment">// 专业</span></span><br><span class="line">    QuaType    <span class="keyword">string</span>    <span class="string">`json:"QuaType"`</span>    <span class="comment">// 学历类别</span></span><br><span class="line">    Length    <span class="keyword">string</span>    <span class="string">`json:"Length"`</span>    <span class="comment">// 学制</span></span><br><span class="line">    Mode    <span class="keyword">string</span>    <span class="string">`json:"Mode"`</span>    <span class="comment">// 学习形式</span></span><br><span class="line">    Level    <span class="keyword">string</span>    <span class="string">`json:"Level"`</span>    <span class="comment">// 层次</span></span><br><span class="line">    Graduation    <span class="keyword">string</span>    <span class="string">`json:"Graduation"`</span>    <span class="comment">// 毕（结）业</span></span><br><span class="line">    CertNo    <span class="keyword">string</span>    <span class="string">`json:"CertNo"`</span>    <span class="comment">// 证书编号</span></span><br><span class="line"></span><br><span class="line">    Photo    <span class="keyword">string</span>    <span class="string">`json:"Photo"`</span>    <span class="comment">// 照片</span></span><br><span class="line"></span><br><span class="line">    Historys    []HistoryItem    <span class="comment">// 当前edu的历史记录</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HistoryItem <span class="keyword">struct</span> &#123;</span><br><span class="line">    TxId    <span class="keyword">string</span></span><br><span class="line">    Education    Education</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-2-3-编写链码"><a href="#13-2-3-编写链码" class="headerlink" title="13.2.3 编写链码"></a>13.2.3 编写链码</h3><p>在 <code>chaincode</code> 目录下创建一个 <code>main.go</code> 的文件并对其进行编辑</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim chaincode/main.go</span></span><br></pre></td></tr></table></figure>

<p><code>main.go</code> 文件作为链码的主文件，主要声明 <code>Init(stub shim.ChaincodeStubInterface)、Invoke(stub shim.ChaincodeStubInterface)</code> 函数，完成对链码初始化及调用的相关实现，完整代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  @Author : hanxiaodong</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/hyperledger/fabric/core/chaincode/shim"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"github.com/hyperledger/fabric/protos/peer"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> EducationChaincode <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *EducationChaincode)</span> <span class="title">Init</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">peer</span>.<span class="title">Response</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *EducationChaincode)</span> <span class="title">Invoke</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">peer</span>.<span class="title">Response</span></span>&#123;</span><br><span class="line">    <span class="comment">// 获取用户意图</span></span><br><span class="line">    fun, args := stub.GetFunctionAndParameters()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> fun == <span class="string">"addEdu"</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t.addEdu(stub, args)        <span class="comment">// 添加信息</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> fun == <span class="string">"queryEduByCertNoAndName"</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> t.queryEduByCertNoAndName(stub, args)        <span class="comment">// 根据证书编号及姓名查询信息</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> fun == <span class="string">"queryEduInfoByEntityID"</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> t.queryEduInfoByEntityID(stub, args)    <span class="comment">// 根据身份证号码及姓名查询详情</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> fun == <span class="string">"updateEdu"</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> t.updateEdu(stub, args)        <span class="comment">// 根据证书编号更新信息</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> fun == <span class="string">"delEdu"</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t.delEdu(stub, args)    <span class="comment">// 根据证书编号删除信息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shim.Error(<span class="string">"指定的函数名称错误"</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    err := shim.Start(<span class="built_in">new</span>(EducationChaincode))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">        fmt.Printf(<span class="string">"启动EducationChaincode时发生错误: %s"</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 <code>eduCC.go</code> 文件，该文件实现了使用链码相关的API对分类账本状态进行具体操作的各个函数：</p>
<ul>
<li><strong>PutEdu：</strong>实现将指定的对象序列化后保存至分类账本中</li>
<li><strong>GetEduInfo：</strong>根据指定的Key（身份证号码）查询对应的状态，反序列后将对象返回</li>
<li><strong>getEduByQueryString：</strong>根据指定的查询字符串从 <code>CouchDB</code> 中查询状态</li>
<li><strong>addEdu：</strong>接收对象并调用 <code>PutEdu</code> 函数实现保存状态的功能</li>
<li><strong>queryEduByCertNoAndName：</strong>根据指定的证书编号与姓名查询状态</li>
<li><strong>queryEduInfoByEntityID：</strong>根据指定的身份证号码（Key）查询状态</li>
<li><strong>updateEdu：</strong>实现对状态进行编辑功能</li>
<li><strong>delEdu：</strong>从分类账本中删除状态，此功能暂不提供</li>
</ul>
<p><code>eduCC.go</code> 文件完整内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  @Author : hanxiaodong</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/hyperledger/fabric/core/chaincode/shim"</span></span><br><span class="line">    <span class="string">"github.com/hyperledger/fabric/protos/peer"</span></span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"bytes"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DOC_TYPE = <span class="string">"eduObj"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存edu</span></span><br><span class="line"><span class="comment">// args: education</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PutEdu</span><span class="params">(stub shim.ChaincodeStubInterface, edu Education)</span> <span class="params">([]<span class="keyword">byte</span>, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    edu.ObjectType = DOC_TYPE</span><br><span class="line"></span><br><span class="line">    b, err := json.Marshal(edu)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存edu状态</span></span><br><span class="line">    err = stub.PutState(edu.EntityID, b)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> b, <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据身份证号码查询信息状态</span></span><br><span class="line"><span class="comment">// args: entityID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetEduInfo</span><span class="params">(stub shim.ChaincodeStubInterface, entityID <span class="keyword">string</span>)</span> <span class="params">(Education, <span class="keyword">bool</span>)</span></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> edu Education</span><br><span class="line">    <span class="comment">// 根据身份证号码查询信息状态</span></span><br><span class="line">    b, err := stub.GetState(entityID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> edu, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> b == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> edu, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对查询到的状态进行反序列化</span></span><br><span class="line">    err = json.Unmarshal(b, &amp;edu)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> edu, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回结果</span></span><br><span class="line">    <span class="keyword">return</span> edu, <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据指定的查询字符串实现富查询</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getEduByQueryString</span><span class="params">(stub shim.ChaincodeStubInterface, queryString <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    resultsIterator, err := stub.GetQueryResult(queryString)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span>  resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// buffer is a JSON array containing QueryRecords</span></span><br><span class="line">    <span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line"></span><br><span class="line">    bArrayMemberAlreadyWritten := <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> resultsIterator.HasNext() &#123;</span><br><span class="line">        queryResponse, err := resultsIterator.Next()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Add a comma before array members, suppress it for the first array member</span></span><br><span class="line">        <span class="keyword">if</span> bArrayMemberAlreadyWritten == <span class="literal">true</span> &#123;</span><br><span class="line">            buffer.WriteString(<span class="string">","</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Record is a JSON object, so we write as-is</span></span><br><span class="line">        buffer.WriteString(<span class="keyword">string</span>(queryResponse.Value))</span><br><span class="line">        bArrayMemberAlreadyWritten = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Printf(<span class="string">"- getQueryResultForQueryString queryResult:\n%s\n"</span>, buffer.String())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buffer.Bytes(), <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加信息</span></span><br><span class="line"><span class="comment">// args: educationObject</span></span><br><span class="line"><span class="comment">// 身份证号为 key, Education 为 value</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *EducationChaincode)</span> <span class="title">addEdu</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">peer</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">2</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"给定的参数个数不符合要求"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> edu Education</span><br><span class="line">    err := json.Unmarshal([]<span class="keyword">byte</span>(args[<span class="number">0</span>]), &amp;edu)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"反序列化信息时发生错误"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查重: 身份证号码必须唯一</span></span><br><span class="line">    _, exist := GetEduInfo(stub, edu.EntityID)</span><br><span class="line">    <span class="keyword">if</span> exist &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"要添加的身份证号码已存在"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _, bl := PutEdu(stub, edu)</span><br><span class="line">    <span class="keyword">if</span> !bl &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"保存信息时发生错误"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = stub.SetEvent(args[<span class="number">1</span>], []<span class="keyword">byte</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shim.Success([]<span class="keyword">byte</span>(<span class="string">"信息添加成功"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据证书编号及姓名查询信息</span></span><br><span class="line"><span class="comment">// args: CertNo, name</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *EducationChaincode)</span> <span class="title">queryEduByCertNoAndName</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">peer</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">2</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"给定的参数个数不符合要求"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    CertNo := args[<span class="number">0</span>]</span><br><span class="line">    name := args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼装CouchDB所需要的查询字符串(是标准的一个JSON串)</span></span><br><span class="line">    <span class="comment">// queryString := fmt.Sprintf("&#123;\"selector\":&#123;\"docType\":\"eduObj\", \"CertNo\":\"%s\"&#125;&#125;", CertNo)</span></span><br><span class="line">    queryString := fmt.Sprintf(<span class="string">"&#123;\"selector\":&#123;\"docType\":\"%s\", \"CertNo\":\"%s\", \"Name\":\"%s\"&#125;&#125;"</span>, DOC_TYPE, CertNo, name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询数据</span></span><br><span class="line">    result, err := getEduByQueryString(stub, queryString)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"根据证书编号及姓名查询信息时发生错误"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> result == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"根据指定的证书编号及姓名没有查询到相关的信息"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> shim.Success(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据身份证号码查询详情（溯源）</span></span><br><span class="line"><span class="comment">// args: entityID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *EducationChaincode)</span> <span class="title">queryEduInfoByEntityID</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">peer</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"给定的参数个数不符合要求"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据身份证号码查询edu状态</span></span><br><span class="line">    b, err := stub.GetState(args[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"根据身份证号码查询信息失败"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> b == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"根据身份证号码没有查询到相关的信息"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对查询到的状态进行反序列化</span></span><br><span class="line">    <span class="keyword">var</span> edu Education</span><br><span class="line">    err = json.Unmarshal(b, &amp;edu)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>  shim.Error(<span class="string">"反序列化edu信息失败"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取历史变更数据</span></span><br><span class="line">    iterator, err := stub.GetHistoryForKey(edu.EntityID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"根据指定的身份证号码查询对应的历史变更数据失败"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> iterator.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 迭代处理</span></span><br><span class="line">    <span class="keyword">var</span> historys []HistoryItem</span><br><span class="line">    <span class="keyword">var</span> hisEdu Education</span><br><span class="line">    <span class="keyword">for</span> iterator.HasNext() &#123;</span><br><span class="line">        hisData, err := iterator.Next()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> shim.Error(<span class="string">"获取edu的历史变更数据失败"</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> historyItem HistoryItem</span><br><span class="line">        historyItem.TxId = hisData.TxId</span><br><span class="line">        json.Unmarshal(hisData.Value, &amp;hisEdu)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hisData.Value == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> empty Education</span><br><span class="line">            historyItem.Education = empty</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            historyItem.Education = hisEdu</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        historys = <span class="built_in">append</span>(historys, historyItem)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    edu.Historys = historys</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回</span></span><br><span class="line">    result, err := json.Marshal(edu)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"序列化edu信息时发生错误"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> shim.Success(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据身份证号更新信息</span></span><br><span class="line"><span class="comment">// args: educationObject</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *EducationChaincode)</span> <span class="title">updateEdu</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">peer</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">2</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"给定的参数个数不符合要求"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> info Education</span><br><span class="line">    err := json.Unmarshal([]<span class="keyword">byte</span>(args[<span class="number">0</span>]), &amp;info)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>  shim.Error(<span class="string">"反序列化edu信息失败"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据身份证号码查询信息</span></span><br><span class="line">    result, bl := GetEduInfo(stub, info.EntityID)</span><br><span class="line">    <span class="keyword">if</span> !bl&#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"根据身份证号码查询信息时发生错误"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result.EnrollDate = info.EnrollDate</span><br><span class="line">    result.GraduationDate = info.GraduationDate</span><br><span class="line">    result.SchoolName = info.SchoolName</span><br><span class="line">    result.Major = info.Major</span><br><span class="line">    result.QuaType = info.QuaType</span><br><span class="line">    result.Length = info.Length</span><br><span class="line">    result.Mode = info.Mode</span><br><span class="line">    result.Level = info.Level</span><br><span class="line">    result.Graduation = info.Graduation</span><br><span class="line">    result.CertNo = info.CertNo;</span><br><span class="line"></span><br><span class="line">    _, bl = PutEdu(stub, result)</span><br><span class="line">    <span class="keyword">if</span> !bl &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"保存信息信息时发生错误"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = stub.SetEvent(args[<span class="number">1</span>], []<span class="keyword">byte</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shim.Success([]<span class="keyword">byte</span>(<span class="string">"信息更新成功"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据身份证号删除信息（暂不对外提供）</span></span><br><span class="line"><span class="comment">// args: entityID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *EducationChaincode)</span> <span class="title">delEdu</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">peer</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">2</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"给定的参数个数不符合要求"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*var edu Education</span></span><br><span class="line"><span class="comment">    result, bl := GetEduInfo(stub, info.EntityID)</span></span><br><span class="line"><span class="comment">    err := json.Unmarshal(result, &amp;edu)</span></span><br><span class="line"><span class="comment">    if err != nil &#123;</span></span><br><span class="line"><span class="comment">        return shim.Error("反序列化信息时发生错误")</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    err := stub.DelState(args[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(<span class="string">"删除信息时发生错误"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = stub.SetEvent(args[<span class="number">1</span>], []<span class="keyword">byte</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shim.Success([]<span class="keyword">byte</span>(<span class="string">"信息删除成功"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>链码编写好以后，我们需要使用 Fabric-SDK-Go 提供的相关 API 来实现对链码的安装及实例化操作，而无需在命令提示符中输入烦锁的相关操作命令。接下来依次完成如下步骤：</p>
<ul>
<li>安装依赖：相关内容及代码请参见第十一章第二节中的内容。</li>
<li>链码自动布署：相关内容代码请参见第十一章第四节中的内容</li>
</ul>
<h3 id="业务层实现"><a href="#业务层实现" class="headerlink" title="业务层实现"></a>业务层实现</h3><h3 id="13-3-1-事件处理"><a href="#13-3-1-事件处理" class="headerlink" title="13.3.1 事件处理"></a>13.3.1 事件处理</h3><p>在项目根目录下创建一个 <code>service</code> 目录作为业务层，在业务层中，我们使用 <code>Fabric-SDK-Go</code> 提供的接口对象调用相应的 API 以实现对链码的访问，最终实现对分类账本中的状态进行操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kongyixueyuan.com/education</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir service</span></span><br></pre></td></tr></table></figure>

<p>在 <code>service</code> 目录下创建 <code>domain.go</code> 文件并进行编辑， 声明一个结构体及对事件相关而封装的源代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim service/domain.go</span></span><br></pre></td></tr></table></figure>

<p><code>domain.go</code> 文件完整内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  @Author : hanxiaodong</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> service</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/hyperledger/fabric-sdk-go/pkg/client/channel"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">    <span class="string">"github.com/hyperledger/fabric-sdk-go/pkg/common/providers/fab"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Education <span class="keyword">struct</span> &#123;</span><br><span class="line">    ObjectType    <span class="keyword">string</span>    <span class="string">`json:"docType"`</span></span><br><span class="line">    Name    <span class="keyword">string</span>    <span class="string">`json:"Name"`</span>        <span class="comment">// 姓名</span></span><br><span class="line">    Gender    <span class="keyword">string</span>    <span class="string">`json:"Gender"`</span>        <span class="comment">// 性别</span></span><br><span class="line">    Nation    <span class="keyword">string</span>    <span class="string">`json:"Nation"`</span>        <span class="comment">// 民族</span></span><br><span class="line">    EntityID    <span class="keyword">string</span>    <span class="string">`json:"EntityID"`</span>        <span class="comment">// 身份证号</span></span><br><span class="line">    Place    <span class="keyword">string</span>    <span class="string">`json:"Place"`</span>        <span class="comment">// 籍贯</span></span><br><span class="line">    BirthDay    <span class="keyword">string</span>    <span class="string">`json:"BirthDay"`</span>        <span class="comment">// 出生日期</span></span><br><span class="line">    EnrollDate    <span class="keyword">string</span>    <span class="string">`json:"EnrollDate"`</span>        <span class="comment">// 入学日期</span></span><br><span class="line">    GraduationDate    <span class="keyword">string</span>    <span class="string">`json:"GraduationDate"`</span>    <span class="comment">// 毕（结）业日期</span></span><br><span class="line">    SchoolName    <span class="keyword">string</span>    <span class="string">`json:"SchoolName"`</span>    <span class="comment">// 学校名称</span></span><br><span class="line">    Major    <span class="keyword">string</span>    <span class="string">`json:"Major"`</span>    <span class="comment">// 专业</span></span><br><span class="line">    QuaType    <span class="keyword">string</span>    <span class="string">`json:"QuaType"`</span>    <span class="comment">// 学历类别</span></span><br><span class="line">    Length    <span class="keyword">string</span>    <span class="string">`json:"Length"`</span>    <span class="comment">// 学制</span></span><br><span class="line">    Mode    <span class="keyword">string</span>    <span class="string">`json:"Mode"`</span>    <span class="comment">// 学习形式</span></span><br><span class="line">    Level    <span class="keyword">string</span>    <span class="string">`json:"Level"`</span>    <span class="comment">// 层次</span></span><br><span class="line">    Graduation    <span class="keyword">string</span>    <span class="string">`json:"Graduation"`</span>    <span class="comment">// 毕（结）业</span></span><br><span class="line">    CertNo    <span class="keyword">string</span>    <span class="string">`json:"CertNo"`</span>    <span class="comment">// 证书编号</span></span><br><span class="line"></span><br><span class="line">    Photo    <span class="keyword">string</span>    <span class="string">`json:"Photo"`</span>    <span class="comment">// 照片</span></span><br><span class="line"></span><br><span class="line">    Historys    []HistoryItem    <span class="comment">// 当前edu的历史记录</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HistoryItem <span class="keyword">struct</span> &#123;</span><br><span class="line">    TxId    <span class="keyword">string</span></span><br><span class="line">    Education    Education</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ServiceSetup <span class="keyword">struct</span> &#123;</span><br><span class="line">    ChaincodeID    <span class="keyword">string</span></span><br><span class="line">    Client    *channel.Client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">regitserEvent</span><span class="params">(client *channel.Client, chaincodeID, eventID <span class="keyword">string</span>)</span> <span class="params">(fab.Registration, &lt;-<span class="keyword">chan</span> *fab.CCEvent)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    reg, notifier, err := client.RegisterChaincodeEvent(chaincodeID, eventID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"注册链码事件失败: %s"</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> reg, notifier</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">eventResult</span><span class="params">(notifier &lt;-<span class="keyword">chan</span> *fab.CCEvent, eventID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ccEvent := &lt;-notifier:</span><br><span class="line">        fmt.Printf(<span class="string">"接收到链码事件: %v\n"</span>, ccEvent)</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(time.Second * <span class="number">20</span>):</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">"不能根据指定的事件ID接收到相应的链码事件(%s)"</span>, eventID)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-3-2-业务层调用链码实现添加状态"><a href="#13-3-2-业务层调用链码实现添加状态" class="headerlink" title="13.3.2 业务层调用链码实现添加状态"></a>13.3.2 业务层调用链码实现添加状态</h3><p>在 <code>service</code> 目录下创建 <code>eduService.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim service/eduService.go</span></span><br></pre></td></tr></table></figure>

<p>在 <code>eduService.go</code> 文件中编写内容如下，通过一个 <code>SaveEdu</code> 函数实现链码的调用，向分类账本中添加状态的功能：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  author: hanxiaodong</span></span><br><span class="line"><span class="comment">  QQ群（专业Fabric交流群）：862733552</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> service</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/hyperledger/fabric-sdk-go/pkg/client/channel"</span></span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *ServiceSetup)</span> <span class="title">SaveEdu</span><span class="params">(edu Education)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    eventID := <span class="string">"eventAddEdu"</span></span><br><span class="line">    reg, notifier := regitserEvent(t.Client, t.ChaincodeID, eventID)</span><br><span class="line">    <span class="keyword">defer</span> t.Client.UnregisterChaincodeEvent(reg)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将edu对象序列化成为字节数组</span></span><br><span class="line">    b, err := json.Marshal(edu)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"指定的edu对象序列化时发生错误"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    req := channel.Request&#123;ChaincodeID: t.ChaincodeID, Fcn: <span class="string">"addEdu"</span>, Args: [][]<span class="keyword">byte</span>&#123;b, []<span class="keyword">byte</span>(eventID)&#125;&#125;</span><br><span class="line">    respone, err := t.Client.Execute(req)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = eventResult(notifier, eventID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(respone.TransactionID), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试添加状态</strong></p>
<p>编辑 <code>main.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim main.go</span></span><br></pre></td></tr></table></figure>

<p><code>main.go</code> 中创建两个 <code>edu</code> 个对象，并调用 <code>SaveEdu</code> 函数，内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  author: hanxiaodong</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    [......]</span><br><span class="line">    <span class="string">"github.com/kongyixueyuan.com/education/service"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">[......]</span><br><span class="line">    <span class="comment">//===========================================//</span></span><br><span class="line"></span><br><span class="line">    serviceSetup := service.ServiceSetup&#123;</span><br><span class="line">        ChaincodeID:EduCC,</span><br><span class="line">        Client:channelClient,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    edu := service.Education&#123;</span><br><span class="line">        Name: <span class="string">"张三"</span>,</span><br><span class="line">        Gender: <span class="string">"男"</span>,</span><br><span class="line">        Nation: <span class="string">"汉"</span>,</span><br><span class="line">        EntityID: <span class="string">"101"</span>,</span><br><span class="line">        Place: <span class="string">"北京"</span>,</span><br><span class="line">        BirthDay: <span class="string">"1991年01月01日"</span>,</span><br><span class="line">        EnrollDate: <span class="string">"2009年9月"</span>,</span><br><span class="line">        GraduationDate: <span class="string">"2013年7月"</span>,</span><br><span class="line">        SchoolName: <span class="string">"中国政法大学"</span>,</span><br><span class="line">        Major: <span class="string">"社会学"</span>,</span><br><span class="line">        QuaType: <span class="string">"普通"</span>,</span><br><span class="line">        Length: <span class="string">"四年"</span>,</span><br><span class="line">        Mode: <span class="string">"普通全日制"</span>,</span><br><span class="line">        Level: <span class="string">"本科"</span>,</span><br><span class="line">        Graduation: <span class="string">"毕业"</span>,</span><br><span class="line">        CertNo: <span class="string">"111"</span>,</span><br><span class="line">        Photo: <span class="string">"/static/phone/11.png"</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    edu2 := service.Education&#123;</span><br><span class="line">        Name: <span class="string">"李四"</span>,</span><br><span class="line">        Gender: <span class="string">"男"</span>,</span><br><span class="line">        Nation: <span class="string">"汉"</span>,</span><br><span class="line">        EntityID: <span class="string">"102"</span>,</span><br><span class="line">        Place: <span class="string">"上海"</span>,</span><br><span class="line">        BirthDay: <span class="string">"1992年02月01日"</span>,</span><br><span class="line">        EnrollDate: <span class="string">"2010年9月"</span>,</span><br><span class="line">        GraduationDate: <span class="string">"2014年7月"</span>,</span><br><span class="line">        SchoolName: <span class="string">"中国人民大学"</span>,</span><br><span class="line">        Major: <span class="string">"行政管理"</span>,</span><br><span class="line">        QuaType: <span class="string">"普通"</span>,</span><br><span class="line">        Length: <span class="string">"四年"</span>,</span><br><span class="line">        Mode: <span class="string">"普通全日制"</span>,</span><br><span class="line">        Level: <span class="string">"本科"</span>,</span><br><span class="line">        Graduation: <span class="string">"毕业"</span>,</span><br><span class="line">        CertNo: <span class="string">"222"</span>,</span><br><span class="line">        Photo: <span class="string">"/static/phone/22.png"</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg, err := serviceSetup.SaveEdu(edu)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err.Error())</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"信息发布成功, 交易编号为: "</span> + msg)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg, err = serviceSetup.SaveEdu(edu2)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err.Error())</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"信息发布成功, 交易编号为: "</span> + msg)</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//===========================================//</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>make</code> 命令运行应用程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p>执行后如下图所示：</p>
<p><img src="http://image.chaindesk.cn/saveedu.png/mark" alt="测试添加状态"></p>
<h3 id="13-3-3-调用链码实现根据证书编号与名称查询状态"><a href="#13-3-3-调用链码实现根据证书编号与名称查询状态" class="headerlink" title="13.3.3 调用链码实现根据证书编号与名称查询状态"></a>13.3.3 调用链码实现根据证书编号与名称查询状态</h3><p>通过上面的 <code>SaveEdu(edu Education)</code> 函数，实现了向分类账本中添加状态，那么我们还需要实现从该分类账本中根据指定的条件查询出相应的状态，编辑 <code>service/eduService.go</code> 文件，向该文件中添加实现根据证书编号与姓名查询状态的相应代码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim service/eduService.go</span></span><br></pre></td></tr></table></figure>

<p>定义一个 <code>FindEduByCertNoAndName</code> 函数，接收两个字符串类型的参数，分别代表证书编号与姓名，该函数实现通过调用链码而实现查询状态的功能，该函数完整代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[......]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *ServiceSetup)</span> <span class="title">FindEduByCertNoAndName</span><span class="params">(certNo, name <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    req := channel.Request&#123;ChaincodeID: t.ChaincodeID, Fcn: <span class="string">"queryEduByCertNoAndName"</span>, Args: [][]<span class="keyword">byte</span>&#123;[]<span class="keyword">byte</span>(certNo), []<span class="keyword">byte</span>(name)&#125;&#125;</span><br><span class="line">    respone, err := t.Client.Query(req)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> []<span class="keyword">byte</span>&#123;<span class="number">0x00</span>&#125;, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> respone.Payload, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试根据证书编号与名称查询状态</strong></p>
<p>编辑 <code>main.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim main.go</span></span><br></pre></td></tr></table></figure>

<p>在 <code>main.go</code> 文件中添加调用代码如下内容：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[......]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据证书编号与名称查询信息</span></span><br><span class="line">    result, err := serviceSetup.FindEduByCertNoAndName(<span class="string">"222"</span>,<span class="string">"李四"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err.Error())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> edu service.Education</span><br><span class="line">        json.Unmarshal(result, &amp;edu)</span><br><span class="line">        fmt.Println(<span class="string">"根据证书编号与姓名查询信息成功："</span>)</span><br><span class="line">        fmt.Println(edu)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//===========================================//</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>make</code> 命令运行应用程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p>执行后如下图所示：</p>
<p><img src="http://image.chaindesk.cn/findEduByCertNoAndName.png/mark" alt="证书编号查询测试"></p>
<h3 id="13-3-4-调用链码实现根据身份证号码查询状态"><a href="#13-3-4-调用链码实现根据身份证号码查询状态" class="headerlink" title="13.3.4 调用链码实现根据身份证号码查询状态"></a>13.3.4 调用链码实现根据身份证号码查询状态</h3><p>通过上面的 <code>FindEduByCertNoAndName(certNo, name string)</code> 函数，实现从该分类账本中根据指定的证书编号与姓名查询出相应的状态，下面我们来实现根据身份证号码查询状态的功能，编辑 <code>service/eduService.go</code> 文件，向该文件中添加实现根据 key 查询状态的相应代码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim service/eduService.go</span></span><br></pre></td></tr></table></figure>

<p>定义一个 <code>FindEduInfoByEntityID</code> 函数，接收一个字符串类型的参数，代表身份证号码（key），该函数实现通过调用链码而实现查询状态的功能，该函数完整代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[......]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *ServiceSetup)</span> <span class="title">FindEduInfoByEntityID</span><span class="params">(entityID <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    req := channel.Request&#123;ChaincodeID: t.ChaincodeID, Fcn: <span class="string">"queryEduInfoByEntityID"</span>, Args: [][]<span class="keyword">byte</span>&#123;[]<span class="keyword">byte</span>(entityID)&#125;&#125;</span><br><span class="line">    respone, err := t.Client.Query(req)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> []<span class="keyword">byte</span>&#123;<span class="number">0x00</span>&#125;, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> respone.Payload, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试根据身份证号码查询状态</strong></p>
<p>编辑 <code>main.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim main.go</span></span><br></pre></td></tr></table></figure>

<p>在 <code>main.go</code> 文件中添加调用代码如下内容：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[......]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据身份证号码查询信息</span></span><br><span class="line">    result, err = serviceSetup.FindEduInfoByEntityID(<span class="string">"101"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err.Error())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> edu service.Education</span><br><span class="line">        json.Unmarshal(result, &amp;edu)</span><br><span class="line">        fmt.Println(<span class="string">"根据身份证号码查询信息成功："</span>)</span><br><span class="line">        fmt.Println(edu)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//===========================================//</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>make</code> 命令运行应用程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p>执行后如下图所示：</p>
<p><img src="http://image.chaindesk.cn/findEduInfoByEntityID.png/mark" alt="身份证号码查询测试"></p>
<h3 id="13-3-5-调用链码实现修改-添加信息状态"><a href="#13-3-5-调用链码实现修改-添加信息状态" class="headerlink" title="13.3.5 调用链码实现修改/添加信息状态"></a>13.3.5 调用链码实现修改/添加信息状态</h3><p>在一些情况下，有些人才会利用工作的业余时间进修，从而提升学历层次，我们必须要考虑到这种情况，所以需要应用程序实现对已有人员的信息进行编辑的功能；但是编辑并不能将之前的学历信息删除，而是在保留之前状态的基础之上添加新的状态，区块链技术很好的帮我们解决了这个问题。编辑 <code>service/eduService.go</code> 文件，向该文件中添加修改已有状态的相关代码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim service/eduService.go</span></span><br></pre></td></tr></table></figure>

<p>定义一个 <code>ModifyEdu</code> 函数，接收一个 <code>Education</code> 类型的对象，该函数实现通过调用链码而实现对已存在的状态进行修改（添加新信息）的功能，该函数完整代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[......]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *ServiceSetup)</span> <span class="title">ModifyEdu</span><span class="params">(edu Education)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    eventID := <span class="string">"eventModifyEdu"</span></span><br><span class="line">    reg, notifier := regitserEvent(t.Client, t.ChaincodeID, eventID)</span><br><span class="line">    <span class="keyword">defer</span> t.Client.UnregisterChaincodeEvent(reg)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将edu对象序列化成为字节数组</span></span><br><span class="line">    b, err := json.Marshal(edu)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"指定的edu对象序列化时发生错误"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    req := channel.Request&#123;ChaincodeID: t.ChaincodeID, Fcn: <span class="string">"updateEdu"</span>, Args: [][]<span class="keyword">byte</span>&#123;b, []<span class="keyword">byte</span>(eventID)&#125;&#125;</span><br><span class="line">    respone, err := t.Client.Execute(req)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = eventResult(notifier, eventID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(respone.TransactionID), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试修改状态</strong></p>
<p>编辑 <code>main.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim main.go</span></span><br></pre></td></tr></table></figure>

<p>在 <code>main.go</code> 文件中添加调用代码如下内容：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[......]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改/添加信息</span></span><br><span class="line">    info := service.Education&#123;</span><br><span class="line">        Name: <span class="string">"张三"</span>,</span><br><span class="line">        Gender: <span class="string">"男"</span>,</span><br><span class="line">        Nation: <span class="string">"汉"</span>,</span><br><span class="line">        EntityID: <span class="string">"101"</span>,</span><br><span class="line">        Place: <span class="string">"北京"</span>,</span><br><span class="line">        BirthDay: <span class="string">"1991年01月01日"</span>,</span><br><span class="line">        EnrollDate: <span class="string">"2013年9月"</span>,</span><br><span class="line">        GraduationDate: <span class="string">"2015年7月"</span>,</span><br><span class="line">        SchoolName: <span class="string">"中国政法大学"</span>,</span><br><span class="line">        Major: <span class="string">"社会学"</span>,</span><br><span class="line">        QuaType: <span class="string">"普通"</span>,</span><br><span class="line">        Length: <span class="string">"两年"</span>,</span><br><span class="line">        Mode: <span class="string">"普通全日制"</span>,</span><br><span class="line">        Level: <span class="string">"研究生"</span>,</span><br><span class="line">        Graduation: <span class="string">"毕业"</span>,</span><br><span class="line">        CertNo: <span class="string">"333"</span>,</span><br><span class="line">        Photo: <span class="string">"/static/phone/11.png"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    msg, err = serviceSetup.ModifyEdu(info)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err.Error())</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"信息操作成功, 交易编号为: "</span> + msg)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//===========================================//</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>make</code> 命令运行应用程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p>执行后如下图所示：</p>
<p><img src="http://image.chaindesk.cn/modifyEdu.png/mark" alt="修改信息测试"></p>
<p><strong>查看修改之后的状态（根据身份证号码）</strong></p>
<p>状态被修改之后，我们为了确认是否真正修改成功，所以需要调用已经编写好的 <code>FindEduInfoByEntityID(entityID string)</code> 函数实现查询详情的功能。</p>
<p>编辑 <code>main.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim main.go</span></span><br></pre></td></tr></table></figure>

<p>在 <code>main.go</code> 文件中添加调用代码如下内容：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[......]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据身份证号码查询信息</span></span><br><span class="line">    result, err = serviceSetup.FindEduInfoByEntityID(<span class="string">"101"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err.Error())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> edu service.Education</span><br><span class="line">        json.Unmarshal(result, &amp;edu)</span><br><span class="line">        fmt.Println(<span class="string">"根据身份证号码查询信息成功："</span>)</span><br><span class="line">        fmt.Println(edu)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//===========================================//</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>make</code> 命令运行应用程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p>执行后如下图所示：</p>
<p><img src="http://image.chaindesk.cn/update_findEduInfoByEntityID.png/mark" alt="修改信息测试"></p>
<p>从终端的输出结果中可以看到详情信息已从分类账本中被成功查询，接下来我们使用根据证书编号与姓名查询修改之后的信息，看看是否正确</p>
<p><strong>查看修改之后的最新状态（根据证书编号与姓名）</strong></p>
<p>状态被修改之后，我们为了确认是否真正修改成功，所以需要调用已经编写好的 <code>FindEduInfoByEntityID(entityID string)</code> 函数实现查询详情的功能。</p>
<p>编辑 <code>main.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim main.go</span></span><br></pre></td></tr></table></figure>

<p>在 <code>main.go</code> 文件中添加调用代码如下内容：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[......]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据证书编号与名称查询信息</span></span><br><span class="line">    result, err = serviceSetup.FindEduByCertNoAndName(<span class="string">"333"</span>,<span class="string">"张三"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err.Error())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> edu service.Education</span><br><span class="line">        json.Unmarshal(result, &amp;edu)</span><br><span class="line">        fmt.Println(<span class="string">"根据证书编号与姓名查询信息成功："</span>)</span><br><span class="line">        fmt.Println(edu)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//===========================================//</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>make</code> 命令运行应用程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p>执行后如下图所示：</p>
<p><img src="http://image.chaindesk.cn/update_findEduByCertNoAndName.png/mark" alt="修改信息测试"></p>
<h3 id="控制层实现"><a href="#控制层实现" class="headerlink" title="控制层实现"></a>控制层实现</h3><h3 id="13-4-1-设置系统用户"><a href="#13-4-1-设置系统用户" class="headerlink" title="13.4.1 设置系统用户"></a>13.4.1 设置系统用户</h3><p>通过业务层已经实现了利用 <code>fabric-sdk-go</code> 调用链码查询或操作分类账本状态，接下来，我们开始实现Web应用层，应用层将其分为两个部分，</p>
<ul>
<li><strong>控制层</strong></li>
<li><strong>视图层</strong></li>
</ul>
<p>在项目根目录下新创建一个名为 <code>web</code> 的目录，用来存放Web应用层的所有内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kongyixueyuan.com/education</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p web/controller</span></span><br></pre></td></tr></table></figure>

<p>在 <code>web</code> 目录下创建 <code>controller</code> 子目录，在该目录下创建 <code>userInfo.go</code> 、 <code>controllerResponse.go</code> 与 <code>controllerHandler.go</code> 三个文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim web/controller/userInfo.go</span></span><br></pre></td></tr></table></figure>

<p><code>userInfo.go</code> 用来模拟RDB，保存系统用户信息，作为用户登录时核对用户信息，当然，这部分大家可以使用 <code>MySQL</code> 或其它数据库来实现。</p>
<p><code>userInfo.go</code> 完整代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  @Author : hanxiaodong</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"github.com/kongyixueyuan.com/education/service"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Application <span class="keyword">struct</span> &#123;</span><br><span class="line">    Setup *service.ServiceSetup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    LoginName    <span class="keyword">string</span></span><br><span class="line">    Password    <span class="keyword">string</span></span><br><span class="line">    IsAdmin    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    admin := User&#123;LoginName:<span class="string">"Hanxiaodong"</span>, Password:<span class="string">"123456"</span>, IsAdmin:<span class="string">"T"</span>&#125;</span><br><span class="line">    alice := User&#123;LoginName:<span class="string">"ChainDesk"</span>, Password:<span class="string">"123456"</span>, IsAdmin:<span class="string">"T"</span>&#125;</span><br><span class="line">    bob := User&#123;LoginName:<span class="string">"alice"</span>, Password:<span class="string">"123456"</span>, IsAdmin:<span class="string">"F"</span>&#125;</span><br><span class="line">    jack := User&#123;LoginName:<span class="string">"bob"</span>, Password:<span class="string">"123456"</span>, IsAdmin:<span class="string">"F"</span>&#125;</span><br><span class="line"></span><br><span class="line">    users = <span class="built_in">append</span>(users, admin)</span><br><span class="line">    users = <span class="built_in">append</span>(users, alice)</span><br><span class="line">    users = <span class="built_in">append</span>(users, bob)</span><br><span class="line">    users = <span class="built_in">append</span>(users, jack)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isAdmin</span><span class="params">(cuser User)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> cuser.IsAdmin == <span class="string">"T"</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-4-2-处理响应"><a href="#13-4-2-处理响应" class="headerlink" title="13.4.2 处理响应"></a>13.4.2 处理响应</h3><p>创建 <code>controllerResponse.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim web/controller/controllerResponse.go</span></span><br></pre></td></tr></table></figure>

<p><code>controllerResponse.go</code> 主要实现对用户请求的响应，将响应结果返回给客户端浏览器。文件完整代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  @Author : hanxiaodong</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"path/filepath"</span></span><br><span class="line">    <span class="string">"html/template"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ShowView</span><span class="params">(w http.ResponseWriter, r *http.Request, templateName <span class="keyword">string</span>, data <span class="keyword">interface</span>&#123;&#125;)</span></span>  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定视图所在路径</span></span><br><span class="line">    pagePath := filepath.Join(<span class="string">"web"</span>, <span class="string">"tpl"</span>, templateName)</span><br><span class="line"></span><br><span class="line">    resultTemplate, err := template.ParseFiles(pagePath)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"创建模板实例错误: %v"</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = resultTemplate.Execute(w, data)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"在模板中融合数据时发生错误: %v"</span>, err)</span><br><span class="line">        <span class="comment">//fmt.Fprintf(w, "显示在客户端浏览器中的错误信息")</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-4-3-处理请求"><a href="#13-4-3-处理请求" class="headerlink" title="13.4.3 处理请求"></a>13.4.3 处理请求</h3><p>创建 <code>controllerHandler.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim web/controller/controllerHandler.go</span></span><br></pre></td></tr></table></figure>

<p><code>controllerHandler.go</code> 文件主要实现接收用户请求，并根据不同的用户请求调用业务层不同的函数，实现对分类账本的访问。其中需要声明并实现的函数：</p>
<p>文件完整内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  @Author : hanxiaodong</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"github.com/kongyixueyuan.com/education/service"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cuser User</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">LoginView</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line"></span><br><span class="line">    ShowView(w, r, <span class="string">"login.html"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">Index</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line">    ShowView(w, r, <span class="string">"index.html"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">Help</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line">    data := &amp;<span class="keyword">struct</span> &#123;</span><br><span class="line">        CurrentUser User</span><br><span class="line">    &#125;&#123;</span><br><span class="line">        CurrentUser:cuser,</span><br><span class="line">    &#125;</span><br><span class="line">    ShowView(w, r, <span class="string">"help.html"</span>, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户登录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">Login</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    loginName := r.FormValue(<span class="string">"loginName"</span>)</span><br><span class="line">    password := r.FormValue(<span class="string">"password"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> flag <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">for</span> _, user := <span class="keyword">range</span> users &#123;</span><br><span class="line">        <span class="keyword">if</span> user.LoginName == loginName &amp;&amp; user.Password == password &#123;</span><br><span class="line">            cuser = user</span><br><span class="line">            flag = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data := &amp;<span class="keyword">struct</span> &#123;</span><br><span class="line">        CurrentUser User</span><br><span class="line">        Flag <span class="keyword">bool</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        CurrentUser:cuser,</span><br><span class="line">        Flag:<span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> flag &#123;</span><br><span class="line">        <span class="comment">// 登录成功</span></span><br><span class="line">        ShowView(w, r, <span class="string">"index.html"</span>, data)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 登录失败</span></span><br><span class="line">        data.Flag = <span class="literal">true</span></span><br><span class="line">        data.CurrentUser.LoginName = loginName</span><br><span class="line">        ShowView(w, r, <span class="string">"login.html"</span>, data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户登出</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">LoginOut</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line">    cuser = User&#123;&#125;</span><br><span class="line">    ShowView(w, r, <span class="string">"login.html"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示添加信息页面</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">AddEduShow</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line">    data := &amp;<span class="keyword">struct</span> &#123;</span><br><span class="line">        CurrentUser User</span><br><span class="line">        Msg <span class="keyword">string</span></span><br><span class="line">        Flag <span class="keyword">bool</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        CurrentUser:cuser,</span><br><span class="line">        Msg:<span class="string">""</span>,</span><br><span class="line">        Flag:<span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    ShowView(w, r, <span class="string">"addEdu.html"</span>, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">AddEdu</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line"></span><br><span class="line">    edu := service.Education&#123;</span><br><span class="line">        Name:r.FormValue(<span class="string">"name"</span>),</span><br><span class="line">        Gender:r.FormValue(<span class="string">"gender"</span>),</span><br><span class="line">        Nation:r.FormValue(<span class="string">"nation"</span>),</span><br><span class="line">        EntityID:r.FormValue(<span class="string">"entityID"</span>),</span><br><span class="line">        Place:r.FormValue(<span class="string">"place"</span>),</span><br><span class="line">        BirthDay:r.FormValue(<span class="string">"birthDay"</span>),</span><br><span class="line">        EnrollDate:r.FormValue(<span class="string">"enrollDate"</span>),</span><br><span class="line">        GraduationDate:r.FormValue(<span class="string">"graduationDate"</span>),</span><br><span class="line">        SchoolName:r.FormValue(<span class="string">"schoolName"</span>),</span><br><span class="line">        Major:r.FormValue(<span class="string">"major"</span>),</span><br><span class="line">        QuaType:r.FormValue(<span class="string">"quaType"</span>),</span><br><span class="line">        Length:r.FormValue(<span class="string">"length"</span>),</span><br><span class="line">        Mode:r.FormValue(<span class="string">"mode"</span>),</span><br><span class="line">        Level:r.FormValue(<span class="string">"level"</span>),</span><br><span class="line">        Graduation:r.FormValue(<span class="string">"graduation"</span>),</span><br><span class="line">        CertNo:r.FormValue(<span class="string">"certNo"</span>),</span><br><span class="line">        Photo:r.FormValue(<span class="string">"photo"</span>),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    app.Setup.SaveEdu(edu)</span><br><span class="line"></span><br><span class="line">    r.Form.Set(<span class="string">"certNo"</span>, edu.CertNo)</span><br><span class="line">    r.Form.Set(<span class="string">"name"</span>, edu.Name)</span><br><span class="line">    app.FindCertByNoAndName(w, r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">QueryPage</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line">    data := &amp;<span class="keyword">struct</span> &#123;</span><br><span class="line">        CurrentUser User</span><br><span class="line">        Msg <span class="keyword">string</span></span><br><span class="line">        Flag <span class="keyword">bool</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        CurrentUser:cuser,</span><br><span class="line">        Msg:<span class="string">""</span>,</span><br><span class="line">        Flag:<span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    ShowView(w, r, <span class="string">"query.html"</span>, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据证书编号与姓名查询信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">FindCertByNoAndName</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line">    certNo := r.FormValue(<span class="string">"certNo"</span>)</span><br><span class="line">    name := r.FormValue(<span class="string">"name"</span>)</span><br><span class="line">    result, err := app.Setup.FindEduByCertNoAndName(certNo, name)</span><br><span class="line">    <span class="keyword">var</span> edu = service.Education&#123;&#125;</span><br><span class="line">    json.Unmarshal(result, &amp;edu)</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"根据证书编号与姓名查询信息成功："</span>)</span><br><span class="line">    fmt.Println(edu)</span><br><span class="line"></span><br><span class="line">    data := &amp;<span class="keyword">struct</span> &#123;</span><br><span class="line">        Edu service.Education</span><br><span class="line">        CurrentUser User</span><br><span class="line">        Msg <span class="keyword">string</span></span><br><span class="line">        Flag <span class="keyword">bool</span></span><br><span class="line">        History <span class="keyword">bool</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        Edu:edu,</span><br><span class="line">        CurrentUser:cuser,</span><br><span class="line">        Msg:<span class="string">""</span>,</span><br><span class="line">        Flag:<span class="literal">false</span>,</span><br><span class="line">        History:<span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        data.Msg = err.Error()</span><br><span class="line">        data.Flag = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ShowView(w, r, <span class="string">"queryResult.html"</span>, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">QueryPage2</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line">    data := &amp;<span class="keyword">struct</span> &#123;</span><br><span class="line">        CurrentUser User</span><br><span class="line">        Msg <span class="keyword">string</span></span><br><span class="line">        Flag <span class="keyword">bool</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        CurrentUser:cuser,</span><br><span class="line">        Msg:<span class="string">""</span>,</span><br><span class="line">        Flag:<span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    ShowView(w, r, <span class="string">"query2.html"</span>, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据身份证号码查询信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">FindByID</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line">    entityID := r.FormValue(<span class="string">"entityID"</span>)</span><br><span class="line">    result, err := app.Setup.FindEduInfoByEntityID(entityID)</span><br><span class="line">    <span class="keyword">var</span> edu = service.Education&#123;&#125;</span><br><span class="line">    json.Unmarshal(result, &amp;edu)</span><br><span class="line"></span><br><span class="line">    data := &amp;<span class="keyword">struct</span> &#123;</span><br><span class="line">        Edu service.Education</span><br><span class="line">        CurrentUser User</span><br><span class="line">        Msg <span class="keyword">string</span></span><br><span class="line">        Flag <span class="keyword">bool</span></span><br><span class="line">        History <span class="keyword">bool</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        Edu:edu,</span><br><span class="line">        CurrentUser:cuser,</span><br><span class="line">        Msg:<span class="string">""</span>,</span><br><span class="line">        Flag:<span class="literal">false</span>,</span><br><span class="line">        History:<span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        data.Msg = err.Error()</span><br><span class="line">        data.Flag = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ShowView(w, r, <span class="string">"queryResult.html"</span>, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改/添加新信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">ModifyShow</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line">    <span class="comment">// 根据证书编号与姓名查询信息</span></span><br><span class="line">    certNo := r.FormValue(<span class="string">"certNo"</span>)</span><br><span class="line">    name := r.FormValue(<span class="string">"name"</span>)</span><br><span class="line">    result, err := app.Setup.FindEduByCertNoAndName(certNo, name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> edu = service.Education&#123;&#125;</span><br><span class="line">    json.Unmarshal(result, &amp;edu)</span><br><span class="line"></span><br><span class="line">    data := &amp;<span class="keyword">struct</span> &#123;</span><br><span class="line">        Edu service.Education</span><br><span class="line">        CurrentUser User</span><br><span class="line">        Msg <span class="keyword">string</span></span><br><span class="line">        Flag <span class="keyword">bool</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        Edu:edu,</span><br><span class="line">        CurrentUser:cuser,</span><br><span class="line">        Flag:<span class="literal">true</span>,</span><br><span class="line">        Msg:<span class="string">""</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        data.Msg = err.Error()</span><br><span class="line">        data.Flag = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ShowView(w, r, <span class="string">"modify.html"</span>, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改/添加新信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">Modify</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    edu := service.Education&#123;</span><br><span class="line">        Name:r.FormValue(<span class="string">"name"</span>),</span><br><span class="line">        Gender:r.FormValue(<span class="string">"gender"</span>),</span><br><span class="line">        Nation:r.FormValue(<span class="string">"nation"</span>),</span><br><span class="line">        EntityID:r.FormValue(<span class="string">"entityID"</span>),</span><br><span class="line">        Place:r.FormValue(<span class="string">"place"</span>),</span><br><span class="line">        BirthDay:r.FormValue(<span class="string">"birthDay"</span>),</span><br><span class="line">        EnrollDate:r.FormValue(<span class="string">"enrollDate"</span>),</span><br><span class="line">        GraduationDate:r.FormValue(<span class="string">"graduationDate"</span>),</span><br><span class="line">        SchoolName:r.FormValue(<span class="string">"schoolName"</span>),</span><br><span class="line">        Major:r.FormValue(<span class="string">"major"</span>),</span><br><span class="line">        QuaType:r.FormValue(<span class="string">"quaType"</span>),</span><br><span class="line">        Length:r.FormValue(<span class="string">"length"</span>),</span><br><span class="line">        Mode:r.FormValue(<span class="string">"mode"</span>),</span><br><span class="line">        Level:r.FormValue(<span class="string">"level"</span>),</span><br><span class="line">        Graduation:r.FormValue(<span class="string">"graduation"</span>),</span><br><span class="line">        CertNo:r.FormValue(<span class="string">"certNo"</span>),</span><br><span class="line">        Photo:r.FormValue(<span class="string">"photo"</span>),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    app.Setup.ModifyEdu(edu)</span><br><span class="line"></span><br><span class="line">    r.Form.Set(<span class="string">"entityID"</span>, edu.EntityID)</span><br><span class="line">    app.FindByID(w, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>提示：用户在做一些管理操作时需要验证其它是否有相应的操作权限，需要另外进行设计。</p>
</blockquote>
<h3 id="13-4-4-指定路由"><a href="#13-4-4-指定路由" class="headerlink" title="13.4.4 指定路由"></a>13.4.4 指定路由</h3><p>在 <code>web</code> 目录下创建一个 <code>webServer.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim web/webServer.go</span></span><br></pre></td></tr></table></figure>

<p>该文件主要声明用户请求的路由信息，并且指定 Web 服务的启动信息。文件完整内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  @Author : hanxiaodong</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> web</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"github.com/kongyixueyuan.com/education/web/controller"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动Web服务并指定路由信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WebStart</span><span class="params">(app controller.Application)</span></span>  &#123;</span><br><span class="line"></span><br><span class="line">    fs:= http.FileServer(http.Dir(<span class="string">"web/static"</span>))</span><br><span class="line">    http.Handle(<span class="string">"/static/"</span>, http.StripPrefix(<span class="string">"/static/"</span>, fs))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定路由信息(匹配请求)</span></span><br><span class="line">    http.HandleFunc(<span class="string">"/"</span>, app.LoginView)</span><br><span class="line">    http.HandleFunc(<span class="string">"/login"</span>, app.Login)</span><br><span class="line">    http.HandleFunc(<span class="string">"/loginout"</span>, app.LoginOut)</span><br><span class="line"></span><br><span class="line">    http.HandleFunc(<span class="string">"/index"</span>, app.Index)</span><br><span class="line">    http.HandleFunc(<span class="string">"/help"</span>, app.Help)</span><br><span class="line"></span><br><span class="line">    http.HandleFunc(<span class="string">"/addEduInfo"</span>, app.AddEduShow)    <span class="comment">// 显示添加信息页面</span></span><br><span class="line">    http.HandleFunc(<span class="string">"/addEdu"</span>, app.AddEdu)    <span class="comment">// 提交信息请求</span></span><br><span class="line"></span><br><span class="line">    http.HandleFunc(<span class="string">"/queryPage"</span>, app.QueryPage)    <span class="comment">// 转至根据证书编号与姓名查询信息页面</span></span><br><span class="line">    http.HandleFunc(<span class="string">"/query"</span>, app.FindCertByNoAndName)    <span class="comment">// 根据证书编号与姓名查询信息</span></span><br><span class="line"></span><br><span class="line">    http.HandleFunc(<span class="string">"/queryPage2"</span>, app.QueryPage2)    <span class="comment">// 转至根据身份证号码查询信息页面</span></span><br><span class="line">    http.HandleFunc(<span class="string">"/query2"</span>, app.FindByID)    <span class="comment">// 根据身份证号码查询信息</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    http.HandleFunc(<span class="string">"/modifyPage"</span>, app.ModifyShow)    <span class="comment">// 修改信息页面</span></span><br><span class="line">    http.HandleFunc(<span class="string">"/modify"</span>, app.Modify)    <span class="comment">//  修改信息</span></span><br><span class="line"></span><br><span class="line">    http.HandleFunc(<span class="string">"/upload"</span>, app.UploadFile)</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"启动Web服务, 监听端口号为: 9000"</span>)</span><br><span class="line">    err := http.ListenAndServe(<span class="string">":9000"</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"Web服务启动失败: %v"</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="视图层实现"><a href="#视图层实现" class="headerlink" title="视图层实现"></a>视图层实现</h3><h3 id="13-5-1-目录结构"><a href="#13-5-1-目录结构" class="headerlink" title="13.5.1 目录结构"></a>13.5.1 目录结构</h3><p>在项目的web目录下新创建一个名为 <code>static</code> 的目录，用来存放Web应用视图层的所有静态内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kongyixueyuan.com/education</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir web/static</span></span><br></pre></td></tr></table></figure>

<p><strong><code>web/static</code>目录下包括四个子目录，分别为：</strong></p>
<ul>
<li><code>web/static/css</code> ：用于存放控制页面布局及显示样式所需的 <code>CSS</code> 文件</li>
<li><code>web/static/js</code> ：用于存放编写的与用户交互的 <code>JavaScript</code> 源代码文件</li>
<li><code>web/static/images</code>：用户存放页面显示所需的所有图片文件</li>
<li><code>web/static/photo</code>：用于存储添加信息时上传的图片文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p web/static/css</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p web/static/images</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p web/static/js</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p web/static/photo</span></span><br></pre></td></tr></table></figure>

<p>在项目的web目录下新创建一个名为 <code>tpl</code> 的目录，用来存放Web应用响应客户端的模板页面</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir web/tpl</span></span><br></pre></td></tr></table></figure>

<p>在 <code>web/tpl</code> 目录下主要有如下页面：</p>
<ul>
<li><code>login.html</code>：用户登录页面</li>
<li><code>index.html</code>：用户登录成功之后进入的首页面</li>
<li><code>help.html</code>： 显示帮助信息及相关操作的链接页面</li>
<li><code>query.html</code>：根据证书编号与姓名查询的页面</li>
<li><code>query2.html</code>：根据身份证号码查询的页面</li>
<li><code>queryResult.html</code>：根据不同的查询请求显示查询结果的页面</li>
<li><code>addEdu.html</code>：添加信息的页面</li>
<li><code>modify.html</code>：修改信息的页面</li>
</ul>
<h3 id="13-5-2-相关源码实现"><a href="#13-5-2-相关源码实现" class="headerlink" title="13.5.2 相关源码实现"></a>13.5.2 相关源码实现</h3><p>相关源代码请参考：</p>
<p>CSS 部分：</p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/static/css/addEdu.css" target="_blank" rel="noopener">web/static/css/addEdu.css</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/static/css/bootstrap.min.css" target="_blank" rel="noopener">web/static/css/bootstrap.min.css</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/static/css/help.css" target="_blank" rel="noopener">web/static/css/help.css</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/static/css/index.css" target="_blank" rel="noopener">web/static/css/index.css</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/static/css/login.css" target="_blank" rel="noopener">web/static/css/login.css</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/static/css/query.css" target="_blank" rel="noopener">web/static/css/query.css</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/static/css/queryResult.css" target="_blank" rel="noopener">web/static/css/queryResult.css</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/static/css/reset.css" target="_blank" rel="noopener">web/static/css/reset.css</a></p>
<p>JavaScript 部分</p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/static/js/bootstrap.min.js" target="_blank" rel="noopener">web/static/js/bootstrap.min.js</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/static/js/jquery.min.js" target="_blank" rel="noopener">web/static/js/jquery.min.js</a></p>
<p>HTML 页面模板部分：</p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/tpl/addEdu.html" target="_blank" rel="noopener">web/tpl/addEdu.html</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/tpl/help.html" target="_blank" rel="noopener">web/tpl/help.html</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/tpl/index.html" target="_blank" rel="noopener">web/tpl/index.html</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/tpl/login.html" target="_blank" rel="noopener">web/tpl/login.html</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/tpl/modify.html" target="_blank" rel="noopener">web/tpl/modify.html</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/tpl/query.html" target="_blank" rel="noopener">web/tpl/query.html</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/tpl/query2.html" target="_blank" rel="noopener">web/tpl/query2.html</a></p>
<p><a href="https://github.com/kevin-hf/education/blob/master/web/tpl/queryResult.html" target="_blank" rel="noopener">web/tpl/queryResult.html</a></p>
<h3 id="13-5-3-照片上传"><a href="#13-5-3-照片上传" class="headerlink" title="13.5.3 照片上传"></a>13.5.3 照片上传</h3><p>在添加信息时需要额外实现一个功能－添加照片</p>
<p>使用jQuery Ajax功能实现</p>
<p>HTML代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"headImg"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"uploadImg"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">value</span>=<span class="string">"上传照片"</span> <span class="attr">id</span>=<span class="string">"file"</span>&gt;</span></span><br><span class="line">          +</span><br><span class="line">          <span class="comment">&lt;!-- &lt;img src="./images/head.jpg" alt=""&gt; --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>请上传照片(120*160px)<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>JavaScript代码如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 上传图片</span></span><br><span class="line">$(<span class="string">'#file'</span>).unbind(<span class="string">'change'</span>).bind(<span class="string">'change'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    event.stopPropagation();</span><br><span class="line">    uploadFile(<span class="string">'img'</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 头像图片</span></span><br><span class="line"><span class="keyword">var</span> artImg;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">    event.stopPropagation();</span><br><span class="line">    <span class="keyword">let</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line">    <span class="keyword">if</span>( type == <span class="string">"img"</span>)&#123;</span><br><span class="line">        formData.append(<span class="string">'file'</span>, $(<span class="string">'#file'</span>)[<span class="number">0</span>].files[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: <span class="string">'/upload'</span>,</span><br><span class="line">        type: <span class="string">'POST'</span>,</span><br><span class="line">        cache: <span class="literal">false</span>,</span><br><span class="line">        data: formData,</span><br><span class="line">        processData: <span class="literal">false</span>,</span><br><span class="line">        dataType: <span class="string">"json"</span>,</span><br><span class="line">        contentType: <span class="literal">false</span></span><br><span class="line">    &#125;).done(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (res.error == <span class="string">"0"</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>( type == <span class="string">"img"</span>)&#123;</span><br><span class="line">                $(<span class="string">'.uploadImg img'</span>).attr(<span class="string">'src'</span>,res.result.path);</span><br><span class="line">                $(<span class="string">'#photo'</span>).val(res.result.path)</span><br><span class="line">                <span class="keyword">return</span> artImg = res.result.path;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alert(<span class="string">"上传失败！"</span> + res.result.msg)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).fail(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123; &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>web/controller</code> 目录下创建一个 <code>upload.go</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim web/controller/upload.go</span></span><br></pre></td></tr></table></figure>

<p><code>upload.go</code> 文件主要利用 Ajax完成 照片传功能的，完整代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  @Author : hanxiaodong</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"io/ioutil"</span></span><br><span class="line">    <span class="string">"crypto/rand"</span></span><br><span class="line">    <span class="string">"path/filepath"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">    <span class="string">"mime"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *Application)</span> <span class="title">UploadFile</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>  &#123;</span><br><span class="line"></span><br><span class="line">    start := <span class="string">"&#123;"</span></span><br><span class="line">    content := <span class="string">""</span></span><br><span class="line">    end := <span class="string">"&#125;"</span></span><br><span class="line"></span><br><span class="line">    file, _, err := r.FormFile(<span class="string">"file"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        content = <span class="string">"\"error\":1,\"result\":&#123;\"msg\":\"指定了无效的文件\",\"path\":\"\"&#125;"</span></span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(start + content + end))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">    fileBytes, err := ioutil.ReadAll(file)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        content = <span class="string">"\"error\":1,\"result\":&#123;\"msg\":\"无法读取文件内容\",\"path\":\"\"&#125;"</span></span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(start + content + end))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    filetype := http.DetectContentType(fileBytes)</span><br><span class="line">    <span class="comment">//log.Println("filetype = " + filetype)</span></span><br><span class="line">    <span class="keyword">switch</span> filetype &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"image/jpeg"</span>, <span class="string">"image/jpg"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"image/gif"</span>, <span class="string">"image/png"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"application/pdf"</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        content = <span class="string">"\"error\":1,\"result\":&#123;\"msg\":\"文件类型错误\",\"path\":\"\"&#125;"</span></span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(start + content + end))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fileName := randToken(<span class="number">12</span>)    <span class="comment">// 指定文件名</span></span><br><span class="line">    fileEndings, err := mime.ExtensionsByType(filetype)    <span class="comment">// 获取文件扩展名</span></span><br><span class="line">    <span class="comment">//log.Println("fileEndings = " + fileEndings[0])</span></span><br><span class="line">    <span class="comment">// 指定文件存储路径</span></span><br><span class="line">    newPath := filepath.Join(<span class="string">"web"</span>, <span class="string">"static"</span>, <span class="string">"photo"</span>, fileName + fileEndings[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">//fmt.Printf("FileType: %s, File: %s\n", filetype, newPath)</span></span><br><span class="line"></span><br><span class="line">    newFile, err := os.Create(newPath)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(<span class="string">"创建文件失败："</span> + err.Error())</span><br><span class="line">        content = <span class="string">"\"error\":1,\"result\":&#123;\"msg\":\"创建文件失败\",\"path\":\"\"&#125;"</span></span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(start + content + end))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> newFile.Close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _, err := newFile.Write(fileBytes); err != <span class="literal">nil</span> || newFile.Close() != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(<span class="string">"写入文件失败："</span> + err.Error())</span><br><span class="line">        content = <span class="string">"\"error\":1,\"result\":&#123;\"msg\":\"保存文件内容失败\",\"path\":\"\"&#125;"</span></span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(start + content + end))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    path := <span class="string">"/static/photo/"</span> + fileName + fileEndings[<span class="number">0</span>]</span><br><span class="line">    content = <span class="string">"\"error\":0,\"result\":&#123;\"fileType\":\"image/png\",\"path\":\""</span> + path + <span class="string">"\",\"fileName\":\"ce73ac68d0d93de80d925b5a.png\"&#125;"</span></span><br><span class="line">    w.Write([]<span class="keyword">byte</span>(start + content + end))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">randToken</span><span class="params">(<span class="built_in">len</span> <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>)</span><br><span class="line">    rand.Read(b)</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"%x"</span>, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="项目交互演示"><a href="#项目交互演示" class="headerlink" title="项目交互演示"></a>项目交互演示</h3><h3 id="13-6-1-启动Web服务"><a href="#13-6-1-启动Web服务" class="headerlink" title="13.6.1 启动Web服务"></a>13.6.1 启动Web服务</h3><p>最后编辑 <code>main.go</code> ，以便启动Web界面实现Web应用程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim main.go</span></span><br></pre></td></tr></table></figure>

<p>添加如下内容:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(</span><br><span class="line">    [......]</span><br><span class="line">    <span class="string">"github.com/kongyixueyuan.com/education/web/controller"</span></span><br><span class="line">    <span class="string">"github.com/kongyixueyuan.com/education/web"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    [......]</span><br><span class="line"></span><br><span class="line">    app := controller.Application&#123;</span><br><span class="line">        Setup: &amp;serviceSetup,</span><br><span class="line">    &#125;</span><br><span class="line">    web.WebStart(app)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应用项目开发完成后，可以直接启动用来查看效果。在命令提示符中输入 <code>make</code> 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<h3 id="13-6-2-访问页面"><a href="#13-6-2-访问页面" class="headerlink" title="13.6.2 访问页面"></a>13.6.2 访问页面</h3><p>项目启动成功之后，打开浏览器访问: <a href="http://localhost:9000/" target="_blank" rel="noopener">htt://localhost:9000/</a></p>
<p>根据访问的URL地址系统自动响应登录页面</p>
<p><img src="http://image.chaindesk.cn/html_login.png/mark" alt="login"></p>
<p>输入管理员账号及密码登录验证成功，则进入系统首页面</p>
<p><img src="http://image.chaindesk.cn/html_index.png/mark" alt="login"></p>
<p>在首页面中点击 <code>查询范围</code>链接，进入 <code>help</code>页面，</p>
<p><img src="http://image.chaindesk.cn/html_help.png/mark" alt="login"></p>
<p>点击添加学历信息链接进入，添加学历信息页面</p>
<p><img src="http://image.chaindesk.cn/html_addEdu.png/mark" alt="login"></p>
<p>根据学历证书编号与姓名查询页面</p>
<p><img src="http://image.chaindesk.cn/html_queryResultbycert.png/mark" alt="login"></p>
<p>根据学历证书编号与姓名查询结果页面</p>
<p><img src="http://image.chaindesk.cn/html_query.png/mark" alt="certNoAndName"></p>
<p>根据身份证号码查询页面</p>
<p><img src="http://image.chaindesk.cn/html_query2.png/mark" alt="login"></p>
<p>根据身份证号码查询页面查询结果页面</p>
<p><img src="http://image.chaindesk.cn/html_queryResultbyentityid.png/mark" alt="login"></p>
<p>编辑页面</p>
<p><img src="http://image.chaindesk.cn/html_modify.png/mark" alt="login"></p>
<p>编辑成功自动跳转到根据身份证号码查询结果页面</p>
<p><img src="http://image.chaindesk.cn/html_modifyResult.png/mark" alt="login"></p>
<p>项目完整源代码，请 <a href="https://github.com/kevin-hf/education" target="_blank" rel="noopener">点击此处</a></p>
<p>未经授权禁止转载、改编，转载请注明出处！</p>
<p>本文地址: <a href="https://www.chaindesk.cn/witbook/11/223" target="_blank" rel="noopener">https://www.chaindesk.cn/witbook/11/223</a></p>

    </div>

    
    
    
    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

      
    </div>
        <div class="reward-container">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="Hongery 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="Hongery 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Hongery
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yoursite.com/2020/03/27/%E8%81%94%E7%9B%9F%E9%93%BE/%E7%AC%AC13%E7%AB%A0%E5%9F%BA%E4%BA%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%AD%A6%E5%8E%86%E4%BF%A1%E6%81%AF%E5%BE%81%E4%BF%A1%E7%B3%BB%E7%BB%9F/" title="第11章基于区块链技术实现学历信息认证">http://yoursite.com/2020/03/27/联盟链/第13章基于区块链技术实现的学历信息征信系统/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/blockchain/" rel="tag"># blockchain</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/03/26/%E8%81%94%E7%9B%9F%E9%93%BE/%E7%AC%AC7%E7%AB%A0Fabric%E5%85%B1%E8%AF%86%E6%9C%BA%E5%88%B6/" rel="prev" title="第7章Fabric共识机制">
      <i class="fa fa-chevron-left"></i> 第7章Fabric共识机制
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/27/%E8%81%94%E7%9B%9F%E9%93%BE/%E7%AC%AC9%E7%AB%A0Fabric%E5%88%86%E5%B8%83%E5%BC%8F%E8%B4%A6%E6%9C%AC%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" rel="next" title="第9章Fabric分布式账本数据存储">
      第9章Fabric分布式账本数据存储 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#需求分析"><span class="nav-text">需求分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-1-需求分析"><span class="nav-text">13.1.1 需求分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-2-架构设计"><span class="nav-text">13.1.2 架构设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-3-数据模型设计"><span class="nav-text">13.1.3 数据模型设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-4-网络环境"><span class="nav-text">13.1.4 网络环境</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#13-1-4-1-设置环境"><span class="nav-text">13.1.4.1 设置环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-1-4-2-配置docker-compose-yml文件"><span class="nav-text">13.1.4.2 配置docker-compose.yml文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-5-测试网络环境"><span class="nav-text">13.1.5 测试网络环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SDK与链码的实现"><span class="nav-text">SDK与链码的实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-1-创建-config-yaml-文件"><span class="nav-text">13.2.1 创建 config.yaml 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-2-声明结构体"><span class="nav-text">13.2.2 声明结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-3-编写链码"><span class="nav-text">13.2.3 编写链码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#业务层实现"><span class="nav-text">业务层实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-1-事件处理"><span class="nav-text">13.3.1 事件处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-2-业务层调用链码实现添加状态"><span class="nav-text">13.3.2 业务层调用链码实现添加状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-3-调用链码实现根据证书编号与名称查询状态"><span class="nav-text">13.3.3 调用链码实现根据证书编号与名称查询状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-4-调用链码实现根据身份证号码查询状态"><span class="nav-text">13.3.4 调用链码实现根据身份证号码查询状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-5-调用链码实现修改-添加信息状态"><span class="nav-text">13.3.5 调用链码实现修改&#x2F;添加信息状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制层实现"><span class="nav-text">控制层实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-4-1-设置系统用户"><span class="nav-text">13.4.1 设置系统用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-4-2-处理响应"><span class="nav-text">13.4.2 处理响应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-4-3-处理请求"><span class="nav-text">13.4.3 处理请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-4-4-指定路由"><span class="nav-text">13.4.4 指定路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图层实现"><span class="nav-text">视图层实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-5-1-目录结构"><span class="nav-text">13.5.1 目录结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-5-2-相关源码实现"><span class="nav-text">13.5.2 相关源码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-5-3-照片上传"><span class="nav-text">13.5.3 照片上传</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#项目交互演示"><span class="nav-text">项目交互演示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-6-1-启动Web服务"><span class="nav-text">13.6.1 启动Web服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-6-2-访问页面"><span class="nav-text">13.6.2 访问页面</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hongery"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Hongery</p>
  <div class="site-description" itemprop="description">直到这一刻微笑着说话为止，我至少留下了一公升眼泪</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">107</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Hongery" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Hongery" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/weixin_40098405" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_40098405" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1281185088@qq.com" title="E-Mail1 → mailto:1281185088@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail1</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hongery@yeah.net" title="E-Mail2 → mailto:hongery@yeah.net" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail2</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hongery</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">NaNm</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">NaN:aN字</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/clicklove.js"></script>
