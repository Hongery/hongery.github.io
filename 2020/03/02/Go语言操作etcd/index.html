<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="go操作etcdetcd是近几年比较火热的一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现，本文主要介绍etcd的安装和使用。">
<meta property="og:type" content="article">
<meta property="og:title" content="go操作etcd">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;03&#x2F;02&#x2F;Go%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9Cetcd&#x2F;index.html">
<meta property="og:site_name" content="Hongery">
<meta property="og:description" content="go操作etcdetcd是近几年比较火热的一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现，本文主要介绍etcd的安装和使用。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https:&#x2F;&#x2F;www.liwenzhou.com&#x2F;images&#x2F;Go&#x2F;etcd&#x2F;etcd_01.png">
<meta property="og:image" content="https:&#x2F;&#x2F;www.liwenzhou.com&#x2F;images&#x2F;Go&#x2F;etcd&#x2F;etcd_02.png">
<meta property="article:published_time" content="2020-03-02T11:23:35.000Z">
<meta property="article:modified_time" content="2020-03-21T05:02:28.614Z">
<meta property="article:author" content="Hongery">
<meta property="article:tag" content="go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;www.liwenzhou.com&#x2F;images&#x2F;Go&#x2F;etcd&#x2F;etcd_01.png">

<link rel="canonical" href="http://yoursite.com/2020/03/02/Go%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9Cetcd/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>go操作etcd | Hongery</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hongery</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">记录学习中的点点滴滴</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Hongery" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/02/Go%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9Cetcd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Hongery">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hongery">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          go操作etcd
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-02 19:23:35" itemprop="dateCreated datePublished" datetime="2020-03-02T19:23:35+08:00">2020-03-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-21 13:02:28" itemprop="dateModified" datetime="2020-03-21T13:02:28+08:00">2020-03-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Go%E8%BF%9B%E9%98%B6/" itemprop="url" rel="index">
                    <span itemprop="name">Go进阶</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="go操作etcd"><a href="#go操作etcd" class="headerlink" title="go操作etcd"></a>go操作etcd</h1><p>etcd是近几年比较火热的一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现，本文主要介绍etcd的安装和使用。</p>
<a id="more"></a>

<h1 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h1><h2 id="etcd介绍"><a href="#etcd介绍" class="headerlink" title="etcd介绍"></a>etcd介绍</h2><p><strong><a href="https://etcd.io/" target="_blank" rel="noopener">etcd</a>是使用Go语言开发的一个开源的、高可用的分布式key-value存储系统，可以用于配置共享和服务的注册和发现。</strong></p>
<p>类似项目有zookeeper和consul。</p>
<p>etcd具有以下特点：</p>
<ul>
<li>完全复制：集群中的每个节点都可以使用完整的存档</li>
<li>高可用性：Etcd可用于避免硬件的单点故障或网络问题</li>
<li>一致性：每次读取都会返回跨多主机的最新写入</li>
<li>简单：包括一个定义良好、面向用户的API（gRPC）</li>
<li>安全：实现了带有可选的客户端证书身份验证的自动化TLS</li>
<li>快速：每秒10000次写入的基准速度</li>
<li>可靠：使用Raft算法实现了强一致、高可用的服务存储目录</li>
</ul>
<h2 id="etcd应用场景"><a href="#etcd应用场景" class="headerlink" title="etcd应用场景"></a>etcd应用场景</h2><h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>服务发现要解决的也是分布式系统中最常见的问题之一，即在同一个分布式集群中的进程或服务，要如何才能找到对方并建立连接。本质上来说，服务发现就是想要了解集群中是否有进程在监听 udp 或 tcp 端口，并且通过名字就可以查找和连接。</p>
<p><img src="https://www.liwenzhou.com/images/Go/etcd/etcd_01.png" alt="img"></p>
<h3 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h3><p>将一些配置信息放到 etcd 上进行集中管理。</p>
<p>这类场景的使用方式通常是这样：应用在启动的时候主动从 etcd 获取一次配置信息，同时，在 etcd 节点上注册一个 Watcher 并等待，以后每次配置有更新的时候，etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的。</p>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><p>因为 etcd 使用 Raft 算法保持了数据的强一致性，某次操作存储到集群中的值必然是全局一致的，所以很容易实现分布式锁。锁服务有两种使用方式，一是保持独占，二是控制时序。</p>
<ul>
<li><strong>保持独占即所有获取锁的用户最终只有一个可以得到</strong>。etcd 为此提供了一套实现分布式锁原子操作 CAS（<code>CompareAndSwap</code>）的 API。通过设置<code>prevExist</code>值，可以保证在多个节点同时去创建某个目录时，只有一个成功。而创建成功的用户就可以认为是获得了锁。</li>
<li>控制时序，即所有想要获得锁的用户都会被安排执行，但是<strong>获得锁的顺序也是全局唯一的，同时决定了执行顺序</strong>。etcd 为此也提供了一套 API（自动创建有序键），对一个目录建值时指定为<code>POST</code>动作，这样 etcd 会自动在目录下生成一个当前最大的值为键，存储这个新的值（客户端编号）。同时还可以使用 API 按顺序列出所有当前目录下的键值。此时这些键的值就是客户端的时序，而这些键中存储的值可以是代表客户端的编号。</li>
</ul>
<p><img src="https://www.liwenzhou.com/images/Go/etcd/etcd_02.png" alt="img"></p>
<h2 id="为什么用-etcd-而不用ZooKeeper？"><a href="#为什么用-etcd-而不用ZooKeeper？" class="headerlink" title="为什么用 etcd 而不用ZooKeeper？"></a>为什么用 etcd 而不用ZooKeeper？</h2><p>etcd 实现的这些功能，ZooKeeper都能实现。那么为什么要用 etcd 而非直接使用ZooKeeper呢？</p>
<h3 id="为什么不选择ZooKeeper？"><a href="#为什么不选择ZooKeeper？" class="headerlink" title="为什么不选择ZooKeeper？"></a>为什么不选择ZooKeeper？</h3><ol>
<li>部署维护复杂，其使用的<code>Paxos</code>强一致性算法复杂难懂。官方只提供了<code>Java</code>和<code>C</code>两种语言的接口。</li>
<li>使用<code>Java</code>编写引入大量的依赖。运维人员维护起来比较麻烦。</li>
<li>最近几年发展缓慢，不如<code>etcd</code>和<code>consul</code>等后起之秀。</li>
</ol>
<h3 id="为什么选择etcd？"><a href="#为什么选择etcd？" class="headerlink" title="为什么选择etcd？"></a>为什么选择etcd？</h3><ol>
<li>简单。使用 Go 语言编写部署简单；支持HTTP/JSON API,使用简单；使用 Raft 算法保证强一致性让用户易于理解。</li>
<li>etcd 默认数据一更新就进行持久化。</li>
<li>etcd 支持 SSL 客户端安全认证。</li>
</ol>
<p>最后，etcd 作为一个年轻的项目，正在高速迭代和开发中，这既是一个优点，也是一个缺点。优点是它的未来具有无限的可能性，缺点是无法得到大项目长时间使用的检验。然而，目前 <code>CoreOS</code>、<code>Kubernetes</code>和<code>CloudFoundry</code>等知名项目均在生产环境中使用了<code>etcd</code>，所以总的来说，etcd值得你去尝试。</p>
<h2 id="etcd集群"><a href="#etcd集群" class="headerlink" title="etcd集群"></a>etcd集群</h2><p>etcd 作为一个高可用键值存储系统，天生就是为集群化而设计的。由于 Raft 算法在做决策时需要多数节点的投票，所以 etcd 一般部署集群推荐奇数个节点，推荐的数量为 3、5 或者 7 个节点构成一个集群。</p>
<h3 id="搭建一个3节点集群示例："><a href="#搭建一个3节点集群示例：" class="headerlink" title="搭建一个3节点集群示例："></a>搭建一个3节点集群示例：</h3><p>在每个etcd节点指定集群成员，为了区分不同的集群最好同时配置一个独一无二的token。</p>
<p>下面是提前定义好的集群信息，其中<code>n1</code>、<code>n2</code>和<code>n3</code>表示3个不同的etcd节点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TOKEN=token-01</span><br><span class="line">CLUSTER_STATE=new</span><br><span class="line">CLUSTER=n1=http://10.240.0.17:2380,n2=http://10.240.0.18:2380,n3=http://10.240.0.19:2380</span><br></pre></td></tr></table></figure>

<p>在<code>n1</code>这台机器上执行以下命令来启动etcd：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcd --data-dir=data.etcd --name n1 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.17:2380 --listen-peer-urls http://10.240.0.17:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.17:2379 --listen-client-urls http://10.240.0.17:2379 \</span><br><span class="line">	--initial-cluster <span class="variable">$&#123;CLUSTER&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure>

<p>在<code>n2</code>这台机器上执行以下命令启动etcd：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcd --data-dir=data.etcd --name n2 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.18:2380 --listen-peer-urls http://10.240.0.18:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.18:2379 --listen-client-urls http://10.240.0.18:2379 \</span><br><span class="line">	--initial-cluster <span class="variable">$&#123;CLUSTER&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure>

<p>在<code>n3</code>这台机器上执行以下命令启动etcd：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcd --data-dir=data.etcd --name n3 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.19:2380 --listen-peer-urls http://10.240.0.19:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.19:2379 --listen-client-urls http://10.240.0.19:2379 \</span><br><span class="line">	--initial-cluster <span class="variable">$&#123;CLUSTER&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure>

<p>etcd 官网提供了一个可以公网访问的 etcd 存储地址。你可以通过如下命令得到 etcd 服务的目录，并把它作为<code>-discovery</code>参数使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">curl https://discovery.etcd.io/new?size=3</span><br><span class="line">https://discovery.etcd.io/a81b5818e67a6ea83e9d4daea5ecbc92</span><br><span class="line"></span><br><span class="line"><span class="comment"># grab this token</span></span><br><span class="line">TOKEN=token-01</span><br><span class="line">CLUSTER_STATE=new</span><br><span class="line">DISCOVERY=https://discovery.etcd.io/a81b5818e67a6ea83e9d4daea5ecbc92</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">etcd --data-dir=data.etcd --name n1 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.17:2380 --listen-peer-urls http://10.240.0.17:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.17:2379 --listen-client-urls http://10.240.0.17:2379 \</span><br><span class="line">	--discovery <span class="variable">$&#123;DISCOVERY&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">etcd --data-dir=data.etcd --name n2 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.18:2380 --listen-peer-urls http://10.240.0.18:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.18:2379 --listen-client-urls http://10.240.0.18:2379 \</span><br><span class="line">	--discovery <span class="variable">$&#123;DISCOVERY&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">etcd --data-dir=data.etcd --name n3 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.19:2380 --listen-peer-urls http://10.240.0.19:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.19:2379 --listen-client-urls http:/10.240.0.19:2379 \</span><br><span class="line">	--discovery <span class="variable">$&#123;DISCOVERY&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure>

<p>到此etcd集群就搭建起来了，可以使用<code>etcdctl</code>来连接etcd。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">HOST_1=10.240.0.17</span><br><span class="line">HOST_2=10.240.0.18</span><br><span class="line">HOST_3=10.240.0.19</span><br><span class="line">ENDPOINTS=<span class="variable">$HOST_1</span>:2379,<span class="variable">$HOST_2</span>:2379,<span class="variable">$HOST_3</span>:2379</span><br><span class="line"></span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> member list</span><br></pre></td></tr></table></figure>

<h2 id="Go语言操作etcd"><a href="#Go语言操作etcd" class="headerlink" title="Go语言操作etcd"></a>Go语言操作etcd</h2><p>这里使用官方的<a href="https://github.com/etcd-io/etcd/tree/master/clientv3" target="_blank" rel="noopener">etcd/clientv3</a>包来连接etcd并进行相关操作。</p>
<p>可以下载压缩文件使用 下载到github.com etcd  下载windown 。zip</p>
<p>执行命令</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$set ETCDCTL_API=<span class="number">3</span>  <span class="comment">//修改版本</span></span><br><span class="line">$etcd.exe <span class="comment">//开启 第一个cmd窗口</span></span><br><span class="line"><span class="comment">//下面是第二个cmd窗口</span></span><br><span class="line">$C:\Users\huanggang\Downloads\etcd-v3<span class="number">.4</span><span class="number">.4</span>-windows-amd64&gt; etcdctl.exe --endpoints=http:<span class="comment">//127.0.0.1:2379 put huanggang "dsb"</span></span><br><span class="line">OK    <span class="comment">//put</span></span><br><span class="line">$C:\Users\huanggang\Downloads\etcd-v3<span class="number">.4</span><span class="number">.4</span>-windows-amd64&gt;etcdctl.exe --endpoints=http:<span class="comment">//127.0.0.1:2379 get huanggang</span></span><br><span class="line">huanggang</span><br><span class="line">dsb    <span class="comment">//get</span></span><br><span class="line">$C:\Users\huanggang\Downloads\etcd-v3<span class="number">.4</span><span class="number">.4</span>-windows-amd64&gt;etcdctl.exe --endpoints=http:<span class="comment">//127.0.0.1:2379 del huanggang</span></span><br><span class="line"><span class="number">1</span>     <span class="comment">//delete</span></span><br></pre></td></tr></table></figure>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get go.etcd.io/etcd/clientv3</span><br></pre></td></tr></table></figure>

<h3 id="put和get操作"><a href="#put和get操作" class="headerlink" title="put和get操作"></a>put和get操作</h3><p><code>put</code>命令用来设置键值对数据，<code>get</code>命令用来根据key获取值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">	<span class="string">"go.etcd.io/etcd/clientv3"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// etcd client put/get demo</span></span><br><span class="line"><span class="comment">// use etcd/clientv3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">		Endpoints:   []<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:2379"</span>&#125;,</span><br><span class="line">		DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// handle error!</span></span><br><span class="line">		fmt.Printf(<span class="string">"connect to etcd failed, err:%v\n"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">    fmt.Println(<span class="string">"connect to etcd success"</span>)</span><br><span class="line">	<span class="keyword">defer</span> cli.Close()</span><br><span class="line">	<span class="comment">// put</span></span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">	_, err = cli.Put(ctx, <span class="string">"q1mi"</span>, <span class="string">"dsb"</span>)</span><br><span class="line">	cancel()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"put to etcd failed, err:%v\n"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// get</span></span><br><span class="line">	ctx, cancel = context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">	resp, err := cli.Get(ctx, <span class="string">"q1mi"</span>)</span><br><span class="line">	cancel()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"get from etcd failed, err:%v\n"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, ev := <span class="keyword">range</span> resp.Kvs &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%s:%s\n"</span>, ev.Key, ev.Value)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./<span class="number">67</span>etcd_demo.exe</span><br><span class="line">connect to etcd success</span><br><span class="line">q1mi:dsb</span><br></pre></td></tr></table></figure>

<p>遇到问题</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//问题1</span></span><br><span class="line">$ ./<span class="number">67</span>etcd_demo.exe</span><br><span class="line">connect to etcd success</span><br><span class="line">&#123;<span class="string">"level"</span>:<span class="string">"warn"</span>,<span class="string">"ts"</span>:<span class="string">"2020-03-10T14:07:30.307+0800"</span>,<span class="string">"caller"</span>:<span class="string">"clientv3/retry_interceptor.go:61"</span>,<span class="string">"msg"</span>:<span class="string">"retrying of unary invoker failed"</span>,<span class="string">"target"</span>:<span class="string">"endpoint://client-4c5764f2-32f7-460f-94e9-490ee15f39da/127.0.0.1:2379"</span>,<span class="string">"attempt"</span>:<span class="number">0</span>,<span class="string">"error"</span>:<span class="string">"rpc error: code = DeadlineExceeded desc = context deadline exceeded"</span>&#125;</span><br><span class="line">put to etcd failed, err:context deadline exceeded</span><br><span class="line"></span><br><span class="line"><span class="comment">//解决办法  </span></span><br><span class="line"><span class="number">1.</span>需要执行文件夹etcd-v3<span class="number">.4</span><span class="number">.4</span>-windows-amd64下面的etcd.exe</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//问题2  go mod init   </span></span><br><span class="line"><span class="comment">//go build 后出现下面错误</span></span><br><span class="line">github.com/coreos/etcd/clientv3/balancer/resolver/endpoint</span><br><span class="line">..\..\..\..\pkg\mod\github.com\coreos\etcd@v3<span class="number">.3</span><span class="number">.18</span>+incompatible\clientv3\balancer\resolver\endpoint\endpoint.<span class="keyword">go</span>:<span class="number">114</span>:<span class="number">78</span>: undefined: resolver.BuildOption</span><br><span class="line">..\..\..\..\pkg\mod\github.com\coreos\etcd@v3<span class="number">.3</span><span class="number">.18</span>+incompatible\clientv3\balancer\resolver\endpoint\endpoint.<span class="keyword">go</span>:<span class="number">182</span>:<span class="number">31</span>: undefined: resolver.ResolveNowOption</span><br><span class="line"># github.com/coreos/etcd/clientv3/balancer/picker</span><br><span class="line">..\..\..\..\pkg\mod\github.com\coreos\etcd@v3<span class="number">.3</span><span class="number">.18</span>+incompatible\clientv3\balancer\picker\err.<span class="keyword">go</span>:<span class="number">37</span>:<span class="number">44</span>: undefined: balancer.PickOptions</span><br><span class="line">..\..\..\..\pkg\mod\github.com\coreos\etcd@v3<span class="number">.3</span><span class="number">.18</span>+incompatible\clientv3\balancer\picker\roundrobin_balanced.<span class="keyword">go</span>:<span class="number">55</span>:<span class="number">54</span>: undefined: balancer.PickOptions</span><br><span class="line"><span class="comment">//解决办法</span></span><br><span class="line">找到<span class="keyword">go</span>.mod文件</span><br><span class="line">&#123;module studygo/day01/<span class="number">67</span>etcd_demo</span><br><span class="line"><span class="keyword">go</span> <span class="number">1.13</span></span><br><span class="line">require (</span><br><span class="line">	github.com/coreos/etcd v3<span class="number">.3</span><span class="number">.18</span>+incompatible <span class="comment">// indirect</span></span><br><span class="line">	github.com/coreos/pkg v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20180928190104</span><span class="number">-399</span>ea9e2e55f <span class="comment">// indirect</span></span><br><span class="line">	github.com/gogo/protobuf v1<span class="number">.3</span><span class="number">.1</span> <span class="comment">// indirect</span></span><br><span class="line">	github.com/google/uuid v1<span class="number">.1</span><span class="number">.1</span> <span class="comment">// indirect</span></span><br><span class="line">	<span class="keyword">go</span>.etcd.io/etcd v3<span class="number">.3</span><span class="number">.18</span>+incompatible</span><br><span class="line">	<span class="keyword">go</span>.uber.org/zap v1<span class="number">.14</span><span class="number">.0</span> <span class="comment">// indirect</span></span><br><span class="line">	google.golang.org/grpc v1<span class="number">.27</span><span class="number">.1</span> <span class="comment">// indirect</span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将google.golang.org/grpc v1.27.1 // indirect   的版本改成google.golang.org/grpc v1.26.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//使用go mod download 命令下载</span></span><br><span class="line">$<span class="keyword">go</span> mod download </span><br><span class="line"><span class="comment">//下载完成后执行go build</span></span><br><span class="line">$<span class="keyword">go</span> build</span><br><span class="line">$./xxx.exe  <span class="comment">//执行文件</span></span><br><span class="line"><span class="comment">//输出结果</span></span><br><span class="line"> connect to etcd success</span><br><span class="line">q1mi:dsb</span><br></pre></td></tr></table></figure>



<h3 id="watch操作"><a href="#watch操作" class="headerlink" title="watch操作"></a>watch操作</h3><p><code>watch</code>用来获取未来更改的通知。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"go.etcd.io/etcd/clientv3"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// watch demo</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">		Endpoints:   []<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:2379"</span>&#125;,</span><br><span class="line">		DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"connect to etcd failed, err:%v\n"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">"connect to etcd success"</span>)</span><br><span class="line">	<span class="keyword">defer</span> cli.Close()</span><br><span class="line">	<span class="comment">// watch key:q1mi change</span></span><br><span class="line">	rch := cli.Watch(context.Background(), <span class="string">"q1mi"</span>) <span class="comment">// &lt;-chan WatchResponse</span></span><br><span class="line">	<span class="keyword">for</span> wresp := <span class="keyword">range</span> rch &#123;</span><br><span class="line">		<span class="keyword">for</span> _, ev := <span class="keyword">range</span> wresp.Events &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"Type: %s Key:%s Value:%s\n"</span>, ev.Type, ev.Kv.Key, ev.Kv.Value)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将上面的代码保存编译执行，此时程序就会等待etcd中<code>q1mi</code>这个key的变化。</p>
<p>例如：我们打开终端执行以下命令修改、删除、设置<code>q1mi</code>这个key。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd&gt; etcdctl.exe --endpoints=http://127.0.0.1:2379 put q1mi <span class="string">"dsb2"</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">etcd&gt; etcdctl.exe --endpoints=http://127.0.0.1:2379 del q1mi</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">etcd&gt; etcdctl.exe --endpoints=http://127.0.0.1:2379 put q1mi <span class="string">"dsb3"</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>上面的程序都能收到如下通知。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">watch&gt;watch.exe</span><br><span class="line">connect to etcd success</span><br><span class="line">Type: PUT Key:q1mi Value:dsb2</span><br><span class="line">Type: DELETE Key:q1mi Value:</span><br><span class="line">Type: PUT Key:q1mi Value:dsb3</span><br></pre></td></tr></table></figure>

<h3 id="lease租约"><a href="#lease租约" class="headerlink" title="lease租约"></a>lease租约</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// etcd lease</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"go.etcd.io/etcd/clientv3"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">		Endpoints:   []<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:2379"</span>&#125;,</span><br><span class="line">		DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">"connect to etcd success."</span>)</span><br><span class="line">	<span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个5秒的租约</span></span><br><span class="line">	resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 5秒钟之后, /nazha/ 这个key就会被移除</span></span><br><span class="line">	_, err = cli.Put(context.TODO(), <span class="string">"/nazha/"</span>, <span class="string">"dsb"</span>, clientv3.WithLease(resp.ID))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="keepAlive"><a href="#keepAlive" class="headerlink" title="keepAlive"></a>keepAlive</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"go.etcd.io/etcd/clientv3"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// etcd keepAlive</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">		Endpoints:   []<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:2379"</span>&#125;,</span><br><span class="line">		DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">"connect to etcd success."</span>)</span><br><span class="line">	<span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">	resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_, err = cli.Put(context.TODO(), <span class="string">"/nazha/"</span>, <span class="string">"dsb"</span>, clientv3.WithLease(resp.ID))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// the key 'foo' will be kept forever</span></span><br><span class="line">	ch, kaerr := cli.KeepAlive(context.TODO(), resp.ID)</span><br><span class="line">	<span class="keyword">if</span> kaerr != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(kaerr)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		ka := &lt;-ch</span><br><span class="line">		fmt.Println(<span class="string">"ttl:"</span>, ka.TTL)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基于etcd实现分布式锁"><a href="#基于etcd实现分布式锁" class="headerlink" title="基于etcd实现分布式锁"></a>基于etcd实现分布式锁</h3><p><code>go.etcd.io/etcd/clientv3/concurrency</code>在etcd之上实现并发操作，如分布式锁、屏障和选举。</p>
<p>导入该包：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"go.etcd.io/etcd/clientv3/concurrency"</span></span><br></pre></td></tr></table></figure>

<p>基于etcd实现的分布式锁示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cli, err := clientv3.New(clientv3.Config&#123;Endpoints: endpoints&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建两个单独的会话用来演示锁竞争</span></span><br><span class="line">s1, err := concurrency.NewSession(cli)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> s1.Close()</span><br><span class="line">m1 := concurrency.NewMutex(s1, <span class="string">"/my-lock/"</span>)</span><br><span class="line"></span><br><span class="line">s2, err := concurrency.NewSession(cli)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> s2.Close()</span><br><span class="line">m2 := concurrency.NewMutex(s2, <span class="string">"/my-lock/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 会话s1获取锁</span></span><br><span class="line"><span class="keyword">if</span> err := m1.Lock(context.TODO()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"acquired lock for s1"</span>)</span><br><span class="line"></span><br><span class="line">m2Locked := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="built_in">close</span>(m2Locked)</span><br><span class="line">    <span class="comment">// 等待直到会话s1释放了/my-lock/的锁</span></span><br><span class="line">    <span class="keyword">if</span> err := m2.Lock(context.TODO()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := m1.Unlock(context.TODO()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"released lock for s1"</span>)</span><br><span class="line"></span><br><span class="line">&lt;-m2Locked</span><br><span class="line">fmt.Println(<span class="string">"acquired lock for s2"</span>)</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">acquired lock <span class="keyword">for</span> s1</span><br><span class="line">released lock <span class="keyword">for</span> s1</span><br><span class="line">acquired lock <span class="keyword">for</span> s2</span><br></pre></td></tr></table></figure>

<p><a href="https://godoc.org/go.etcd.io/etcd/clientv3/concurrency" target="_blank" rel="noopener">查看文档了解更多</a></p>
<p>其他操作请查看<a href="https://godoc.org/go.etcd.io/etcd/clientv3" target="_blank" rel="noopener">etcd/clientv3官方文档</a>。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://etcd.io/docs/v3.3.12/demo/" target="_blank" rel="noopener">https://etcd.io/docs/v3.3.12/demo/</a></li>
<li><a href="https://www.infoq.cn/article/etcd-interpretation-application-scenario-implement-principle/" target="_blank" rel="noopener">https://www.infoq.cn/article/etcd-interpretation-application-scenario-implement-principle/</a></li>
</ul>

    </div>

    
    
    
    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

      
    </div>
        <div class="reward-container">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="Hongery 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="Hongery 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Hongery
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yoursite.com/2020/03/02/Go%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9Cetcd/" title="go操作etcd">http://yoursite.com/2020/03/02/Go语言操作etcd/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/go/" rel="tag"># go</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/03/02/Go%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9Ckafka/" rel="prev" title="go操作kafka">
      <i class="fa fa-chevron-left"></i> go操作kafka
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/02/Go%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9CNSQ/" rel="next" title="Go语言操作NSQ">
      Go语言操作NSQ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#go操作etcd"><span class="nav-text">go操作etcd</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#etcd"><span class="nav-text">etcd</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd介绍"><span class="nav-text">etcd介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd应用场景"><span class="nav-text">etcd应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务发现"><span class="nav-text">服务发现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置中心"><span class="nav-text">配置中心</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式锁"><span class="nav-text">分布式锁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么用-etcd-而不用ZooKeeper？"><span class="nav-text">为什么用 etcd 而不用ZooKeeper？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么不选择ZooKeeper？"><span class="nav-text">为什么不选择ZooKeeper？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么选择etcd？"><span class="nav-text">为什么选择etcd？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd集群"><span class="nav-text">etcd集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#搭建一个3节点集群示例："><span class="nav-text">搭建一个3节点集群示例：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Go语言操作etcd"><span class="nav-text">Go语言操作etcd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#put和get操作"><span class="nav-text">put和get操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#watch操作"><span class="nav-text">watch操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lease租约"><span class="nav-text">lease租约</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#keepAlive"><span class="nav-text">keepAlive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于etcd实现分布式锁"><span class="nav-text">基于etcd实现分布式锁</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hongery"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Hongery</p>
  <div class="site-description" itemprop="description">直到这一刻微笑着说话为止，我至少留下了一公升眼泪</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Hongery" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Hongery" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/weixin_40098405" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_40098405" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1281185088@qq.com" title="E-Mail1 → mailto:1281185088@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail1</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hongery@yeah.net" title="E-Mail2 → mailto:hongery@yeah.net" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail2</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hongery</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">NaNm</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">NaN:aN字</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/clicklove.js"></script>
